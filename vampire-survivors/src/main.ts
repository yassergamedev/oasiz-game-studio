// @ts-nocheck
// This file contains minified JavaScript extracted from the built file
// TypeScript checking is disabled because the code is minified
(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const c of l.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function t(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(o){if(o.ep)return;o.ep=!0;const l=t(o);fetch(o.href,l)}})();const r={PLAYER_RADIUS:25,PLAYER_SPEED:170,PLAYER_MAX_HP:100,PLAYER_PICKUP_RANGE:80,PLAYER_INVULNERABLE_TIME:1,ENEMY_BASIC_HP:20,ENEMY_BASIC_SPEED:60,ENEMY_BASIC_RADIUS:20,ENEMY_FAST_HP:10,ENEMY_FAST_SPEED:120,ENEMY_FAST_RADIUS:17,ENEMY_TANK_HP:60,ENEMY_TANK_SPEED:40,ENEMY_TANK_RADIUS:30,ENEMY_RANGED_HP:15,ENEMY_RANGED_SPEED:50,ENEMY_RANGED_RADIUS:18,ENEMY_RANGED_ATTACK_RANGE:360,ENEMY_RANGED_FIRE_RATE:1,ENEMY_RANGED_PROJECTILE_SPEED:150,ENEMY_RANGED_PROJECTILE_DAMAGE:8,ENEMY_BOSS_HP:300,ENEMY_BOSS_SPEED:50,ENEMY_BOSS_RADIUS:35,DRAGON_BOSS_HP:500,DRAGON_BOSS_SPEED:60,DRAGON_BOSS_RADIUS:55,DRAGON_FIRE_RATE:.8,DRAGON_FIRE_DAMAGE:12,DRAGON_FIRE_SPEED:250,ENEMY_SPAWN_INTERVAL_START:800,ENEMY_SPAWN_INTERVAL_MIN:150,ENEMY_SPAWN_RATE_INCREASE:20,BOSS_SPAWN_INTERVAL:45,MAGIC_MISSILE_FIRE_RATE:1.5,MAGIC_MISSILE_DAMAGE:10,MAGIC_MISSILE_SPEED:350,MAGIC_MISSILE_LIFETIME:3,MAGIC_MISSILE_RADIUS:4,FIRE_RING_RADIUS:80,FIRE_RING_DAMAGE:15,FIRE_RING_DAMAGE_INTERVAL:.5,FIRE_RING_PARTICLES:20,LIGHTNING_BOLT_FIRE_RATE:.6,LIGHTNING_BOLT_DAMAGE:20,LIGHTNING_BOLT_SEQUENTIAL_DELAY:.15,LIGHTNING_BOLT_SPEED:200,LIGHTNING_BOLT_HOMING_STRENGTH:3,LIGHTNING_BOLT_LIFETIME:1.5,LIGHTNING_BOLT_CHAIN_COUNT:3,LIGHTNING_BOLT_CHAIN_RANGE:350,LIGHTNING_BOLT_RADIUS:5,HOLY_SWORD_FIRE_RATE:1.5,HOLY_SWORD_DAMAGE:25,HOLY_SWORD_RANGE:168,HOLY_SWORD_ARC:Math.PI/2.5,LIGHT_RING_FIRE_RATE:.4,LIGHT_RING_DAMAGE:12,LIGHT_RING_SPEED:120,LIGHT_RING_RETURN_SPEED:200,LIGHT_RING_RADIUS:30,LIGHT_RING_RANGE:300,LIGHT_RING_DAMAGE_INTERVAL:.1,LIGHT_RING_SEQUENTIAL_DELAY:.2,LASER_STRIKE_FIRE_RATE:.7,LASER_STRIKE_DAMAGE:28,LASER_STRIKE_STRIKE_COUNT:2,LASER_STRIKE_DELAY:.05,ARCANE_DART_FIRE_RATE:.5,ARCANE_DART_DAMAGE:25,ARCANE_DART_SPEED:400,ARCANE_DART_LIFETIME:5,ARCANE_DART_RADIUS:12,HOLY_SWORD_SEQUENTIAL_DELAY:.25,HOLY_SWORD_SEQUENTIAL_DELAY_INCREASE:.1,XP_GEM_VALUE:5,XP_GEM_RADIUS:7,XP_GEM_COLLECT_SPEED:200,XP_PER_LEVEL:35,XP_PER_LEVEL_MULTIPLIER:1.15,CHEST_RADIUS:20,CHEST_COLLECT_SPEED:250,DIFFICULTY_SCALE_INTERVAL:20,ENEMY_HP_SCALE:1.15,ENEMY_SPEED_SCALE:1.03,ENEMY_RANGED_FIRE_RATE_SCALE:1.005,ENEMY_RANGED_PROJECTILE_SPEED_SCALE:1.003,ENEMY_RANGED_DAMAGE_SCALE:1.05,BOSS_SPAWN_INTERVAL_LATE:30,SCREEN_SHAKE_DECAY:.9,PARTICLE_LIFETIME:.5,PARTICLE_COUNT_ENEMY_DEATH:15,PARTICLE_COUNT_BOSS_DEATH:40,PARTICLE_COUNT_VICTORY:100,PARTICLE_COUNT_EXPLOSION:30,PARTICLE_COUNT_LASER_STRIKE:20,PARTICLE_COUNT_HIT:5,PARTICLE_COUNT_LIGHT_RING_HIT:3};function je(i,a,t){return Math.max(a,Math.min(t,i))}function w(i,a,t,n){const o=t-i,l=n-a;return Math.sqrt(o*o+l*l)}function de(i,a){const t=Math.sqrt(i*i+a*a);return t===0?{x:0,y:0}:{x:i/t,y:a/t}}function P(i,a){return Math.random()*(a-i)+i}let F,e;const Y=window.matchMedia("(pointer: coarse)").matches,Fe=Y?.75:1,te=Y?.4:1,Pe=!Y,J=Y;let Ae,Le,ie,Re,Be,He,ae,fe,ot,nt,lt,st,rt,Ue,be,We,ct,dt,ft,Ve,$e,Ke,ht,N="START",S=window.innerWidth,u=window.innerHeight,ze=0,p=0,O=0,H=0,h={x:0,y:0,vx:0,vy:0,hp:r.PLAYER_MAX_HP,maxHp:r.PLAYER_MAX_HP,speed:r.PLAYER_SPEED,pickupRange:0,invulnerableTime:0,radius:r.PLAYER_RADIUS*Fe},Ce=1,M=[],L=[],z=[],ee=[],b=[],m=[],xe=null,ye=1,oe=0,se=r.XP_PER_LEVEL,$=0,Xe=0,Qe=r.ENEMY_SPAWN_INTERVAL_START,le=0,k=0,B=0,Je=0,we=0,K=1,me=0,W=1,q=1,re=1,he=1,ge=r.LIGHTNING_BOLT_CHAIN_COUNT,Ge=r.LIGHT_RING_RADIUS,ve=r.LIGHT_RING_SPEED,Ze=r.LIGHT_RING_RETURN_SPEED,ue=r.LASER_STRIKE_STRIKE_COUNT,Ee=2,X=new Set,Me=0,Te=0,Z=0,j=0,Q=!1,G={music:localStorage.getItem("vampireSurvivors_music")!=="false",fx:localStorage.getItem("vampireSurvivors_fx")!=="false",haptics:localStorage.getItem("vampireSurvivors_haptics")!=="false"},U=null;function It(){U=new Audio("https://assets.oasiz.ai/audio/game-music.wav"),U.loop=!0,U.volume=.5,U.preload="auto"}const yt=[{id:"weapon_damage",name:"Weapon Power",description:"+20% all weapon damage",icon:"âš¡",category:"weapon"},{id:"weapon_fire_rate",name:"Rapid Fire",description:"+25% all weapon fire rate",icon:"ðŸ”¥",category:"weapon"},{id:"weapon_projectiles",name:"Multi Shot",description:"+1 projectile per shot",icon:"âœ¨",category:"weapon"},{id:"weapon_range",name:"Extended Range",description:"+20% weapon range/radius",icon:"ðŸ“",category:"weapon"},{id:"player_hp",name:"Vitality",description:"+20 max HP",icon:"â¤ï¸",category:"stat"},{id:"player_speed",name:"Swiftness",description:"+15% movement speed",icon:"ðŸ’¨",category:"stat"},{id:"player_pickup_range",name:"Magnetism",description:"+30% XP pickup range",icon:"ðŸ§²",category:"stat"},{id:"magic_missile",name:"Magic Missile",description:"Unlock Magic Missile weapon",icon:"âœ¨",category:"new_weapon"},{id:"fire_ring",name:"Fire Ring",description:"Unlock Fire Ring weapon",icon:"ðŸ”¥",category:"new_weapon"},{id:"lightning_bolt",name:"Lightning Bolt",description:"Unlock Lightning Bolt weapon",icon:"âš¡",category:"new_weapon"},{id:"holy_sword",name:"Holy Sword",description:"Unlock Holy Sword weapon",icon:"âš”ï¸",category:"new_weapon"},{id:"light_ring",name:"Light Spinner",description:"Unlock Light Spinner weapon",icon:"ðŸ’«",category:"new_weapon"},{id:"laser_strike",name:"Laser Strike",description:"Unlock Laser Strike weapon",icon:"â˜„ï¸",category:"new_weapon"},{id:"arcane_dart",name:"Arcane Dart",description:"Unlock Arcane Dart weapon",icon:"ðŸŽ¯",category:"new_weapon"},{id:"life_steal",name:"Life Steal",description:"Heal 5% of damage dealt",icon:"ðŸ©¸",category:"passive"},{id:"crit_chance",name:"Critical Strike",description:"10% chance for 2x damage",icon:"ðŸ’¥",category:"passive"},{id:"fire_ring_upgrade",name:"Fire Ring Power",description:"+25% Fire Ring damage & radius",icon:"ðŸ”¥",category:"weapon_specific"},{id:"holy_sword_upgrade",name:"Sword Width",description:"+30% Holy Sword swing width",icon:"âš”ï¸",category:"weapon_specific"},{id:"lightning_bolt_upgrade",name:"Lightning Chain",description:"+1 Lightning Bolt chain bounce",icon:"âš¡",category:"weapon_specific"},{id:"magic_missile_upgrade",name:"Magic Barrage",description:"+1 Magic Missile projectile",icon:"âœ¨",category:"weapon_specific"},{id:"light_ring_upgrade",name:"Light Spinner Size",description:"+25% Light Spinner area",icon:"ðŸ’«",category:"weapon_specific"},{id:"laser_strike_upgrade",name:"Laser Barrage",description:"+1 simultaneous Laser Strike",icon:"â˜„ï¸",category:"weapon_specific"},{id:"arcane_dart_upgrade",name:"Arcane Volley",description:"+1 Arcane Dart projectile",icon:"ðŸŽ¯",category:"weapon_specific"}];function et(){if(console.log("[init] Initializing game"),F=document.getElementById("gameCanvas"),!F){console.error("[init] Canvas not found!");return}if(e=F.getContext("2d"),!e){console.error("[init] Could not get 2d context!");return}Ae=document.getElementById("startScreen"),Le=document.getElementById("weaponSelectScreen"),ie=document.getElementById("gameOverScreen"),Re=document.getElementById("victoryScreen"),Be=document.getElementById("upgradeScreen"),He=document.getElementById("settingsModal"),ae=document.getElementById("settingsBtn"),fe=document.getElementById("hud"),ot=document.getElementById("healthBarFill"),nt=document.getElementById("levelDisplay"),lt=document.getElementById("scoreDisplay"),st=document.getElementById("xpBarFill"),rt=document.getElementById("timerDisplay"),Ue=document.getElementById("upgradeCardsContainer"),be=document.getElementById("weaponsDisplay"),We=document.getElementById("startButton"),ct=document.getElementById("restartButton"),dt=document.getElementById("menuButton"),ft=document.getElementById("finalScore"),Ve=document.getElementById("musicToggle"),$e=document.getElementById("fxToggle"),Ke=document.getElementById("hapticsToggle"),ht=document.getElementById("settingsClose"),gt(),mt(),Mt(),De(),It(),m.push({id:"magic_missile",level:1,fireRate:r.MAGIC_MISSILE_FIRE_RATE,lastFireTime:-1,damage:r.MAGIC_MISSILE_DAMAGE,projectileSpeed:r.MAGIC_MISSILE_SPEED,projectileLifetime:r.MAGIC_MISSILE_LIFETIME,type:"projectile"}),requestAnimationFrame(ut)}function gt(){S=window.innerWidth,u=window.innerHeight,F.width=S,F.height=u,h.x=S/2,h.y=u/2,console.log("[resizeCanvas] Canvas resized to",S,"x",u)}function mt(){const i=localStorage.getItem("vampireSurvivors_settings");if(i)try{G=JSON.parse(i)}catch{console.log("[loadSettings] Failed to parse settings")}}function Oe(){localStorage.setItem("vampireSurvivors_settings",JSON.stringify(G))}function De(){Ve.classList.toggle("active",G.music),$e.classList.toggle("active",G.fx),Ke.classList.toggle("active",G.haptics)}function Mt(){if(window.addEventListener("resize",gt),window.addEventListener("keydown",t=>{X.add(t.key.toLowerCase())}),window.addEventListener("keyup",t=>{X.delete(t.key.toLowerCase())}),F.addEventListener("touchstart",t=>{if(N!=="PLAYING")return;t.preventDefault();const n=t.touches[0];Me=n.clientX,Te=n.clientY,Z=n.clientX,j=n.clientY,Q=!0}),F.addEventListener("touchmove",t=>{if(N==="PLAYING"&&(t.preventDefault(),Q)){const n=t.touches[0];Z=n.clientX,j=n.clientY}}),F.addEventListener("touchend",t=>{N==="PLAYING"&&(t.preventDefault(),Q=!1,Z=Me,j=Te)}),F.addEventListener("mousedown",t=>{N!=="PLAYING"||Y||(Me=t.clientX,Te=t.clientY,Z=t.clientX,j=t.clientY,Q=!0)}),F.addEventListener("mousemove",t=>{N!=="PLAYING"||Y||!Q||(Z=t.clientX,j=t.clientY)}),F.addEventListener("mouseup",()=>{N==="PLAYING"&&(Q=!1)}),!We){console.error("[setupEventListeners] startButton not found!");return}We.addEventListener("click",t=>{t.stopPropagation(),Ne(),x("light")}),ct.addEventListener("click",()=>{xe=null,ie.classList.add("hidden"),Ne(),x("light")});const i=document.getElementById("victoryRestartButton"),a=document.getElementById("victoryMenuButton");i.addEventListener("click",()=>{Re.classList.add("hidden"),ie.classList.add("hidden"),xe=null,Ne(),x("light")}),a.addEventListener("click",()=>{N="START",Re.classList.add("hidden"),Ae.classList.remove("hidden"),Le.classList.add("hidden"),fe.classList.add("hidden"),ae.classList.add("hidden"),x("light")}),dt.addEventListener("click",()=>{N="START",F.classList.remove("playing"),Ae.classList.remove("hidden"),Le.classList.add("hidden"),ie.classList.add("hidden"),fe.classList.add("hidden"),ae.classList.add("hidden"),x("light")}),ae.addEventListener("click",()=>{He.classList.remove("hidden"),x("light")}),ht.addEventListener("click",()=>{He.classList.add("hidden"),x("light")}),Ve.addEventListener("click",()=>{G.music=!G.music,De(),Oe(),x("light"),U&&(G.music&&N==="PLAYING"?U.play().catch(()=>{}):U.pause())}),$e.addEventListener("click",()=>{G.fx=!G.fx,De(),Oe(),x("light")}),Ke.addEventListener("click",()=>{G.haptics=!G.haptics,De(),Oe(),x("light")})}function Tt(i){switch(i){case"magic_missile":return{id:"magic_missile",level:1,fireRate:r.MAGIC_MISSILE_FIRE_RATE,lastFireTime:-1,damage:r.MAGIC_MISSILE_DAMAGE,projectileSpeed:r.MAGIC_MISSILE_SPEED,projectileLifetime:r.MAGIC_MISSILE_LIFETIME,type:"projectile"};case"fire_ring":return{id:"fire_ring",level:1,fireRate:0,lastFireTime:-1,damage:r.FIRE_RING_DAMAGE,projectileSpeed:0,projectileLifetime:0,type:"area",radius:r.FIRE_RING_RADIUS,lastDamageTime:0};case"lightning_bolt":return{id:"lightning_bolt",level:1,fireRate:r.LIGHTNING_BOLT_FIRE_RATE,lastFireTime:-1,damage:r.LIGHTNING_BOLT_DAMAGE,projectileSpeed:r.LIGHTNING_BOLT_SPEED,projectileLifetime:r.LIGHTNING_BOLT_LIFETIME,type:"projectile",sequentialShots:[]};case"holy_sword":return{id:"holy_sword",level:1,fireRate:r.HOLY_SWORD_FIRE_RATE,lastFireTime:-1,damage:r.HOLY_SWORD_DAMAGE,projectileSpeed:0,projectileLifetime:0,type:"melee",range:r.HOLY_SWORD_RANGE,arc:r.HOLY_SWORD_ARC,sequentialShots:[]};case"light_ring":return{id:"light_ring",level:1,fireRate:r.LIGHT_RING_FIRE_RATE,lastFireTime:-1,damage:r.LIGHT_RING_DAMAGE,projectileSpeed:r.LIGHT_RING_SPEED,projectileLifetime:10,type:"projectile",sequentialShots:[]};case"laser_strike":return{id:"laser_strike",level:1,fireRate:r.LASER_STRIKE_FIRE_RATE,lastFireTime:-1,damage:r.LASER_STRIKE_DAMAGE,projectileSpeed:800,projectileLifetime:.3,type:"projectile"};case"arcane_dart":return{id:"arcane_dart",level:1,fireRate:r.ARCANE_DART_FIRE_RATE,lastFireTime:-1,damage:r.ARCANE_DART_DAMAGE,projectileSpeed:r.ARCANE_DART_SPEED,projectileLifetime:r.ARCANE_DART_LIFETIME,type:"projectile"};default:return{id:"magic_missile",level:1,fireRate:r.MAGIC_MISSILE_FIRE_RATE,lastFireTime:-1,damage:r.MAGIC_MISSILE_DAMAGE,projectileSpeed:r.MAGIC_MISSILE_SPEED,projectileLifetime:r.MAGIC_MISSILE_LIFETIME,type:"projectile"}}}function Pt(i){const a={magic_missile:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>',fire_ring:'<svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="6" fill="none" stroke="currentColor" stroke-width="1.5"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4" stroke="currentColor" stroke-width="2"/></svg>',lightning_bolt:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>',holy_sword:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.92 5h5.64l2.25 3.83L13.04 9h5.65l-4.5 7.83-.84-1.42L9.75 21 8.03 18.5l2.79-4.85L6.92 5z"/></svg>',light_ring:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><path d="M12 2l2 6 6 2-6 2-2 6-2-6-6-2 6-2z" fill="currentColor" opacity="0.3"/></svg>',laser_strike:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/><circle cx="12" cy="7" r="2" fill="currentColor"/></svg>',arcane_dart:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M12 12l-10 5 10 5 10-5-10-5z"/><circle cx="12" cy="7" r="1.5" fill="currentColor"/><circle cx="12" cy="17" r="1.5" fill="currentColor"/></svg>'};return a[i]||a.magic_missile}function Ne(){console.log("[showWeaponSelectScreen] Showing weapon selection");const t=[...[{id:"magic_missile",name:"Magic Missile",description:"Rapid-fire magical projectiles"},{id:"fire_ring",name:"Fire Ring",description:"Burning circle around you"},{id:"lightning_bolt",name:"Lightning Bolt",description:"Chains between enemies"},{id:"holy_sword",name:"Holy Sword",description:"Melee arc attack"},{id:"light_ring",name:"Light Spinner",description:"Boomerang that damages continuously"},{id:"laser_strike",name:"Laser Strike",description:"Strikes enemies from the sky"},{id:"arcane_dart",name:"Arcane Dart",description:"Piercing projectile that bounces"}]].sort(()=>Math.random()-.5).slice(0,3),n=document.querySelector(".weapon-grid");n&&(n.innerHTML="",t.forEach(o=>{const l=document.createElement("div");l.className="weapon-card",l.setAttribute("data-weapon-id",o.id),l.innerHTML=`
        <div class="weapon-icon">${Pt(o.id)}</div>
        <h3>${o.name}</h3>
        <p>${o.description}</p>
      `,l.addEventListener("click",()=>{xe=o.id,At(),x("light")}),n.appendChild(l)})),Ae.classList.add("hidden"),ie.classList.add("hidden"),Re.classList.add("hidden"),Le.classList.remove("hidden"),N="WEAPON_SELECT"}function At(){if(console.log("[startGame] Starting new game"),!xe){Ne();return}N="PLAYING",p=0,ye=1,oe=0,se=r.XP_PER_LEVEL,$=0,k=0,W=1,q=1,re=1,he=1,ge=r.LIGHTNING_BOLT_CHAIN_COUNT,Ge=r.LIGHT_RING_RADIUS,ve=r.LIGHT_RING_SPEED,Ze=r.LIGHT_RING_RETURN_SPEED,ue=r.LASER_STRIKE_STRIKE_COUNT,Ee=2,B=0,Je=0,we=0,K=1,Qe=r.ENEMY_SPAWN_INTERVAL_START,Xe=0,le=0,me=0,ee=[],h.x=S/2,h.y=u/2,h.vx=0,h.vy=0,h.hp=h.maxHp,h.invulnerableTime=0,h.angle=0,h.animationTime=0;const i=Tt(xe);i.damage*=W,i.fireRate>0&&(i.fireRate*=q),i.type==="melee"&&i.range?i.range*=re:i.type==="area"&&i.radius&&(i.radius*=re),m=[i],M=[],L=[],z=[],b=[],Ae.classList.add("hidden"),Le.classList.add("hidden"),ie.classList.add("hidden"),Be.classList.add("hidden"),fe.classList.remove("hidden"),ae.classList.remove("hidden"),F.classList.add("playing"),V(),G.music&&U&&(U.currentTime=0,U.play().catch(()=>{console.log("[startGame] Music play failed")})),x("light"),pt()}function x(i){if(G.haptics){if(typeof window.triggerHaptic=="function"){window.triggerHaptic(i);return}if(navigator.vibrate&&Y){const a={light:10,medium:20,heavy:50,success:[20,50,20,50,20],error:[100,50,100,50,100]},t=a[i]||a.medium;navigator.vibrate(t)}}}function ut(i){requestAnimationFrame(ut);const a=Math.min((i-ze)/1e3,.1);ze=i,N==="PLAYING"&&(p+=a,Lt(a)),gi()}function Lt(i){Rt(i),Ct(i),Yt(),Jt(i),jt(i),ei(i),di(i),ci(),me>0&&p-me>=2&&(hi(),me=0),fi(),ri(),pt()}function Rt(i){let a=0,t=0;if(Y||Q){const n=Z-Me,o=j-Te;if(Math.sqrt(n*n+o*o)>10){const c=de(n,o);a=c.x,t=c.y}}else(X.has("w")||X.has("arrowup"))&&(t-=1),(X.has("s")||X.has("arrowdown"))&&(t+=1),(X.has("a")||X.has("arrowleft"))&&(a-=1),(X.has("d")||X.has("arrowright"))&&(a+=1);if(a!==0&&t!==0){const n=de(a,t);a=n.x,t=n.y}a!==0&&(Ce=a>0?1:-1),h.vx=a*h.speed,h.vy=t*h.speed,h.x+=h.vx*i,h.y+=h.vy*i,h.x=je(h.x,h.radius,S-h.radius),h.y=je(h.y,h.radius,u-h.radius),h.invulnerableTime>0&&(h.invulnerableTime-=i),h.animationTime+=i*5}function Ct(i){if(B!==3){const t=Date.now();t-Xe>Qe&&(vt(),Xe=t)}const a=p>120?r.BOSS_SPAWN_INTERVAL_LATE:r.BOSS_SPAWN_INTERVAL;if(B===3)M.some(n=>n.type==="dragon"||n.isDragon)||(console.log("[updateEnemies] Volcano map detected, spawning dragon. gameTime:",p,"lastBossSpawnTime:",le),M=[],wt(),le=p,console.log("[updateEnemies] Dragon spawned. Enemy count:",M.length));else if(p>=r.BOSS_SPAWN_INTERVAL&&p-le>=a){const n=we===1?2:we===2?3:1;for(let o=0;o<n;o++)bt();we++,le=p}for(let t=M.length-1;t>=0;t--){const n=M[t];if(n.type==="dragon"||n.isDragon){Dt(n,i);continue}if(n.type==="ranged"){const l=h.x-n.x,c=h.y-n.y,d=Math.sqrt(l*l+c*c);if(d<r.ENEMY_RANGED_ATTACK_RANGE){n.vx=0,n.vy=0,n.angle=Math.atan2(c,l);const s=n.x>=n.radius&&n.x<=S-n.radius&&n.y>=n.radius&&n.y<=u-n.radius,f=n.lastAttackTime||0,E=n.rangedFireRateMultiplier||1,y=1/(r.ENEMY_RANGED_FIRE_RATE*E);s&&p-f>=y&&(xt(n),n.lastAttackTime=p)}else{if(d>0){const s=de(l,c);n.vx=s.x*n.speed,n.vy=s.y*n.speed,n.angle=Math.atan2(c,l)}n.x+=n.vx*i,n.y+=n.vy*i}}else{const l=h.x-n.x,c=h.y-n.y;if(Math.sqrt(l*l+c*c)>0){const s=de(l,c);n.vx=s.x*n.speed,n.vy=s.y*n.speed,n.angle=Math.atan2(c,l)}n.x+=n.vx*i,n.y+=n.vy*i}n.animationTime+=i*3;const o=n.isBoss?.15:.1;n.scale=1+Math.sin(n.animationTime)*o,(n.x<-50||n.x>S+50||n.y<-50||n.y>u+50)&&M.splice(t,1)}}function xt(i){const a=i.angle,t=i.rangedDamageMultiplier||1,n=i.rangedProjectileSpeedMultiplier||1,o=Math.floor(r.ENEMY_RANGED_PROJECTILE_DAMAGE*t),l=r.ENEMY_RANGED_PROJECTILE_SPEED*n,c={x:i.x,y:i.y,vx:Math.cos(a)*l,vy:Math.sin(a)*l,damage:o,lifetime:3,maxLifetime:3,radius:5,weaponId:"enemy_ranged",rotation:a,trail:[],isEnemyProjectile:!0};L.push(c)}function vt(){const i=Math.floor(Math.random()*4);let a=0,t=0;switch(i){case 0:a=Math.random()*S,t=-30;break;case 1:a=S+30,t=Math.random()*u;break;case 2:a=Math.random()*S,t=u+30;break;case 3:a=-30,t=Math.random()*u;break}const n=Math.random();let o,l,c,d,s;p<25?(o="basic",l=r.ENEMY_BASIC_HP,c=r.ENEMY_BASIC_SPEED,d=r.ENEMY_BASIC_RADIUS,s="#8B4513"):p<45?n<.5?(o="basic",l=r.ENEMY_BASIC_HP,c=r.ENEMY_BASIC_SPEED,d=r.ENEMY_BASIC_RADIUS,s="#8B4513"):(o="fast",l=r.ENEMY_FAST_HP,c=r.ENEMY_FAST_SPEED,d=r.ENEMY_FAST_RADIUS,s="#FF6347"):p<60?n<.35?(o="basic",l=r.ENEMY_BASIC_HP,c=r.ENEMY_BASIC_SPEED,d=r.ENEMY_BASIC_RADIUS,s="#8B4513"):n<.6?(o="fast",l=r.ENEMY_FAST_HP,c=r.ENEMY_FAST_SPEED,d=r.ENEMY_FAST_RADIUS,s="#FF6347"):(o="tank",l=r.ENEMY_TANK_HP,c=r.ENEMY_TANK_SPEED,d=r.ENEMY_TANK_RADIUS,s="#2F4F4F"):n<.35?(o="basic",l=r.ENEMY_BASIC_HP,c=r.ENEMY_BASIC_SPEED,d=r.ENEMY_BASIC_RADIUS,s="#8B4513"):n<.6?(o="fast",l=r.ENEMY_FAST_HP,c=r.ENEMY_FAST_SPEED,d=r.ENEMY_FAST_RADIUS,s="#FF6347"):n<.85?(o="tank",l=r.ENEMY_TANK_HP,c=r.ENEMY_TANK_SPEED,d=r.ENEMY_TANK_RADIUS,s="#2F4F4F"):(o="ranged",l=r.ENEMY_RANGED_HP,c=r.ENEMY_RANGED_SPEED,d=r.ENEMY_RANGED_RADIUS,s="#9370DB");const f=Math.floor(p/r.DIFFICULTY_SCALE_INTERVAL),E=p>120?1.2:1,_=f*E;let y=r.ENEMY_HP_SCALE;(o==="basic"||o==="fast")&&(y=1.18);const R=Math.pow(y,_)*K,g=Math.pow(r.ENEMY_SPEED_SCALE,_)*Math.pow(K,.7);l=Math.floor(l*R),c*=g,d=d*Fe;let I=1,T=1,A=1;o==="ranged"&&(I=Math.pow(r.ENEMY_RANGED_FIRE_RATE_SCALE,_),T=Math.pow(r.ENEMY_RANGED_DAMAGE_SCALE,_),A=Math.pow(r.ENEMY_RANGED_PROJECTILE_SPEED_SCALE,_));const C={x:a,y:t,vx:0,vy:0,hp:l,maxHp:l,speed:c,radius:d,type:o,color:s,angle:0,animationTime:Math.random()*Math.PI*2,scale:1,lastFireRingDamage:0,lastAttackTime:0,rangedFireRateMultiplier:I,rangedDamageMultiplier:T,rangedProjectileSpeedMultiplier:A};M.push(C)}function bt(){const i=Math.floor(Math.random()*4);let a=0,t=0;switch(i){case 0:a=Math.random()*S,t=-50;break;case 1:a=S+50,t=Math.random()*u;break;case 2:a=Math.random()*S,t=u+50;break;case 3:a=-50,t=Math.random()*u;break}const n=Math.floor(p/r.DIFFICULTY_SCALE_INTERVAL),o=p>120?1.2:1,l=n*o,c=Math.pow(r.ENEMY_HP_SCALE,l)*Math.pow(K,.8),d=Math.pow(r.ENEMY_SPEED_SCALE,l)*Math.pow(K,.7),s=Math.floor(r.ENEMY_BOSS_HP*c),f=r.ENEMY_BOSS_SPEED*d;M.push({x:a,y:t,vx:0,vy:0,hp:s,maxHp:s,speed:f,radius:r.ENEMY_BOSS_RADIUS*Fe,type:"boss",color:"#DC143C",angle:0,animationTime:Math.random()*Math.PI*2,scale:1,isBoss:!0,lastFireRingDamage:0}),O=10,H=10;for(let E=0;E<30;E++)b.push({x:a+P(-20,20),y:t+P(-20,20),vx:P(-100,100),vy:P(-100,100),life:r.PARTICLE_LIFETIME*1.5,maxLife:r.PARTICLE_LIFETIME*1.5,size:8,color:"#DC143C"});x("heavy"),console.log("[spawnBoss] Boss spawned!")}function wt(){console.log("[spawnDragon] Dragon boss spawning!");const i=S/2,a=u*.2,t=Math.floor(p/r.DIFFICULTY_SCALE_INTERVAL),n=p>120?1.3:1,o=t*n,l=Math.pow(r.ENEMY_HP_SCALE,o)*Math.pow(K,.8),c=Math.pow(r.ENEMY_SPEED_SCALE,o)*Math.pow(K,.7),d=Math.floor(r.DRAGON_BOSS_HP*l),s=r.DRAGON_BOSS_SPEED*c;M.push({x:i,y:a,vx:0,vy:0,hp:d,maxHp:d,speed:s,radius:r.DRAGON_BOSS_RADIUS*Fe,type:"dragon",color:"#FF4500",angle:0,animationTime:Math.random()*Math.PI*2,scale:1,isBoss:!0,isDragon:!0,lastFireRingDamage:0,lastAttackTime:0,attackPhase:0,attackPhaseTime:0}),O=20,H=20;for(let f=0;f<60;f++)b.push({x:i+P(-30,30),y:a+P(-30,30),vx:P(-300,300),vy:P(-300,300),life:r.PARTICLE_LIFETIME*2,maxLife:r.PARTICLE_LIFETIME*2,size:P(8,15),color:"#FF4500"});x("heavy"),console.log("[spawnDragon] Dragon boss spawned!")}function Dt(i,a){i.attackPhase===void 0&&(i.attackPhase=0),i.attackPhaseTime===void 0&&(i.attackPhaseTime=0),i.attackPhaseTime+=a;const t=Math.min(S,u)*.15,n=.5;i.x=S/2+Math.cos(p*n)*t,i.y=u*.25+Math.sin(p*n*.7)*t*.5;const o=h.x-i.x,l=h.y-i.y;i.angle=Math.atan2(l,o);const c=i.lastAttackTime||0,d=1/r.DRAGON_FIRE_RATE;if(p-c>=d){const f=i.attackPhaseTime%3/3,E=Math.floor(i.attackPhaseTime/3)%5;E===0?Nt(i):E===1?Gt(i,f):E===2?Ft(i):E===3?Bt(i):kt(i),i.lastAttackTime=p}i.animationTime+=a*3}function Nt(i){const a=Math.atan2(h.y-i.y,h.x-i.x),t=Math.PI/3,n=5;for(let o=0;o<n;o++){const l=a-t/2+t/(n-1)*o;ce(i,l)}}function Gt(i,a){const n=Math.atan2(h.y-i.y,h.x-i.x)+a*Math.PI*2,o=8;for(let l=0;l<o;l++){const c=n+l/o*Math.PI*2;ce(i,c)}}function Ft(i){const a=Math.atan2(h.y-i.y,h.x-i.x),t=Math.PI/8;ce(i,a-t),ce(i,a),ce(i,a+t)}function Bt(i){for(let t=0;t<12;t++){const n=t/12*Math.PI*2;ce(i,n)}}function ce(i,a){const t={x:i.x,y:i.y,vx:Math.cos(a)*r.DRAGON_FIRE_SPEED,vy:Math.sin(a)*r.DRAGON_FIRE_SPEED,damage:r.DRAGON_FIRE_DAMAGE,lifetime:4,maxLifetime:4,radius:7,weaponId:"dragon_fire",rotation:a,trail:[],isEnemyProjectile:!0};L.push(t)}function kt(i){const a=Math.atan2(h.y-i.y,h.x-i.x),t={x:i.x,y:i.y,vx:Math.cos(a)*r.DRAGON_FIRE_SPEED*.8,vy:Math.sin(a)*r.DRAGON_FIRE_SPEED*.8,damage:r.DRAGON_FIRE_DAMAGE*1.5,lifetime:3,maxLifetime:3,radius:15,weaponId:"dragon_exploding_fireball",rotation:a,trail:[],isEnemyProjectile:!0,willExplode:!0};L.push(t)}function Yt(i){for(const a of m)if(a.type==="projectile"){if(a.id==="lightning_bolt"&&a.sequentialShots&&a.sequentialShots.length>0)for(let o=a.sequentialShots.length-1;o>=0;o--){const l=a.sequentialShots[o];if(p>=l.time){let c=l.targetEnemy;if(c&&M.find(d=>d.id===c.id))tt(a,c);else{let d=null,s=1/0;for(const f of M){const E=w(h.x,h.y,f.x,f.y);E<s&&(s=E,d=f)}d&&tt(a,d)}a.sequentialShots.splice(o,1)}}if(a.id==="light_ring"&&a.sequentialShots&&a.sequentialShots.length>0)for(let o=a.sequentialShots.length-1;o>=0;o--){const l=a.sequentialShots[o];p>=l.time&&l.angle!==void 0&&(Et(a,l.angle),a.sequentialShots.splice(o,1))}const t=a.lastFireTime<0?1/0:p-a.lastFireTime,n=1/a.fireRate;t>=n&&(Ht(a),a.lastFireTime=p)}else if(a.type==="area")a.id==="fire_ring"&&Ot(a);else if(a.type==="melee"){if(a.id==="holy_sword"&&a.sequentialShots&&a.sequentialShots.length>0)for(let o=a.sequentialShots.length-1;o>=0;o--){const l=a.sequentialShots[o];p>=l.time&&l.swingAngle!==void 0&&(qe(a,l.swingAngle),a.sequentialShots.splice(o,1))}const t=a.lastFireTime<0?1/0:p-a.lastFireTime,n=1/a.fireRate;t>=n&&($t(a),a.lastFireTime=p)}}function Ot(i,a){const t=r.FIRE_RING_DAMAGE_INTERVAL;if((i.lastDamageTime===void 0?1/0:p-i.lastDamageTime)>=t){const o=i.radius||r.FIRE_RING_RADIUS;for(let l=M.length-1;l>=0;l--){const c=M[l];if(w(h.x,h.y,c.x,c.y)<=o+c.radius){const s=c.lastFireRingDamage||0;if(p-s>=t){c.hp-=i.damage,c.lastFireRingDamage=p;for(let f=0;f<3;f++)b.push({x:c.x+P(-10,10),y:c.y+P(-10,10),vx:P(-30,30),vy:P(-30,30),life:r.PARTICLE_LIFETIME*.5,maxLife:r.PARTICLE_LIFETIME*.5,size:6,color:"#ff6600"});c.hp<=0&&(ne(c),M.splice(l,1))}}}i.lastDamageTime=p}}function Ht(i){if(i.type!=="projectile")return;if(M.length===0){const c=Math.random()*Math.PI*2,d={x:h.x,y:h.y,vx:Math.cos(c)*i.projectileSpeed,vy:Math.sin(c)*i.projectileSpeed,damage:i.damage,lifetime:i.projectileLifetime,maxLifetime:i.projectileLifetime,radius:r.MAGIC_MISSILE_RADIUS,target:void 0,weaponId:i.id,rotation:c,trail:[]};L.push(d);return}if(i.id==="lightning_bolt"){Ut(i);return}if(i.id==="light_ring"){Wt(i);return}if(i.id==="laser_strike"){Xt(i);return}if(i.id==="arcane_dart"){Vt(i);return}let a=null,t=1/0;for(const c of M){const d=w(h.x,h.y,c.x,c.y);d<t&&(t=d,a=c)}if(!a)return;let n=1;i.id==="magic_missile"?n=he+k:n=1+k;const o=Math.atan2(a.y-h.y,a.x-h.x),l=[];if(l.push({angle:o,offsetX:0,offsetY:0}),n>=2){const c=o+Math.PI;l.push({angle:c,offsetX:0,offsetY:0})}for(let c=2;c<n;c++){const s=c%2===0?o-Math.PI/2:o+Math.PI/2;l.push({angle:s,offsetX:0,offsetY:0})}for(const c of l){const d={x:h.x,y:h.y,vx:Math.cos(c.angle)*i.projectileSpeed,vy:Math.sin(c.angle)*i.projectileSpeed,damage:i.damage,lifetime:i.projectileLifetime,maxLifetime:i.projectileLifetime,radius:r.MAGIC_MISSILE_RADIUS,target:a,weaponId:i.id,rotation:c.angle,trail:[]};L.push(d)}}function Ut(i){if(M.length===0)return;let a=null,t=1/0;for(const o of M){const l=w(h.x,h.y,o.x,o.y);l<t&&(t=l,a=o)}if(!a)return;const n=1+k;i.sequentialShots||(i.sequentialShots=[]);for(let o=0;o<n;o++){const l=o*r.LIGHTNING_BOLT_SEQUENTIAL_DELAY;i.sequentialShots.push({time:p+l,targetEnemy:a})}}function tt(i,a){if(!a)return;const t=Math.atan2(a.y-h.y,a.x-h.x),n={x:h.x,y:h.y,vx:Math.cos(t)*i.projectileSpeed,vy:Math.sin(t)*i.projectileSpeed,damage:i.damage,lifetime:i.projectileLifetime,maxLifetime:i.projectileLifetime,radius:r.LIGHTNING_BOLT_RADIUS,target:a,weaponId:i.id,rotation:t,trail:[],chainCount:ge,hitEnemies:new Set};L.push(n)}function Wt(i){const a=L.filter(l=>l.weaponId==="light_ring"),t=i.fireRate>1.5?2:1;if(a.length>=t)return;const n=k>0?1+k:1;i.sequentialShots||(i.sequentialShots=[]);let o=Math.random()*Math.PI*2;if(M.length>0){let l=null,c=1/0;for(const d of M){const s=w(h.x,h.y,d.x,d.y);s<c&&(c=s,l=d)}l&&(o=Math.atan2(l.y-h.y,l.x-h.x))}if(Et(i,o),k>0)for(let l=1;l<n;l++){const c=l*r.LIGHT_RING_SEQUENTIAL_DELAY;i.sequentialShots.push({time:p+c,angle:o+l*.1})}}function Et(i,a){const t={x:h.x,y:h.y,vx:Math.cos(a)*ve,vy:Math.sin(a)*ve,damage:i.damage,lifetime:10,maxLifetime:10,radius:Ge,weaponId:i.id,rotation:a,trail:[],startX:h.x,startY:h.y,maxDistance:r.LIGHT_RING_RANGE,isReturning:!1,lastDamageTime:0};L.push(t)}function Xt(i){if(M.length===0)return;const a=ue+k,t=[];for(let n=0;n<a;n++)if(M.length>0){const o=Math.floor(Math.random()*M.length);t.push(M[o])}t.forEach((n,o)=>{setTimeout(()=>{qt(i,n)},o*r.LASER_STRIKE_DELAY*1e3)})}function qt(i,a){const t={x:a.x,y:a.y-100,vx:0,vy:800,damage:i.damage,lifetime:.3,maxLifetime:.3,radius:15,weaponId:i.id,rotation:Math.PI/2,trail:[],target:a,hasStruck:!1};L.push(t)}function Vt(i){const a=L.filter(d=>d.weaponId==="arcane_dart"),t=i.fireRate>.5?2:1;if(a.length>=t)return;if(M.length===0){const d=Math.random()*Math.PI*2;it(i,d);return}let n=null,o=1/0;for(const d of M){const s=w(h.x,h.y,d.x,d.y);s<o&&(o=s,n=d)}if(!n)return;const l=Ee+k,c=Math.atan2(n.y-h.y,n.x-h.x);for(let d=0;d<l;d++){const s=(d-(l-1)/2)*.2,f=c+s;it(i,f)}}function it(i,a){const t={x:h.x,y:h.y,vx:Math.cos(a)*r.ARCANE_DART_SPEED,vy:Math.sin(a)*r.ARCANE_DART_SPEED,damage:i.damage,lifetime:r.ARCANE_DART_LIFETIME,maxLifetime:r.ARCANE_DART_LIFETIME,radius:r.ARCANE_DART_RADIUS,weaponId:i.id,rotation:a,trail:[],hitEnemies:new Set,bounceCount:0,maxBounces:10};L.push(t)}function $t(i){i.id==="holy_sword"&&Kt(i)}function Kt(i){if(M.length===0)return;const a=Math.PI,t=0;if(i.sequentialShots||(i.sequentialShots=[]),k===0){const n=Ce>0?t:a;qe(i,n)}else{const n=1+k,o=Ce>0?0:1;qe(i,o===0?t:a);let c=0;for(let d=1;d<n;d++){const s=(o+d)%2===0?t:a,f=r.HOLY_SWORD_SEQUENTIAL_DELAY+(d-1)*r.HOLY_SWORD_SEQUENTIAL_DELAY_INCREASE;c+=f,i.sequentialShots.push({time:p+c,swingAngle:s})}}}function qe(i,a){const t=i.range||r.HOLY_SWORD_RANGE,n=i.arc||r.HOLY_SWORD_ARC,o=new Set;for(let l=M.length-1;l>=0;l--){const c=M[l];if(o.has(c.id))continue;if(w(h.x,h.y,c.x,c.y)<=t+c.radius){let f=Math.atan2(c.y-h.y,c.x-h.x)-a;for(;f>Math.PI;)f-=Math.PI*2;for(;f<-Math.PI;)f+=Math.PI*2;if(Math.abs(f)<=n/2){c.hp-=i.damage,o.add(c.id);for(let E=0;E<5;E++)b.push({x:c.x,y:c.y,vx:P(-50,50),vy:P(-50,50),life:r.PARTICLE_LIFETIME,maxLife:r.PARTICLE_LIFETIME,size:4,color:"#fff"});_e(),c.hp<=0&&(ne(c),M.splice(l,1))}}}Qt(a,t,n)}function Qt(i,a,t){for(let o=0;o<15;o++){const l=o/15,c=i-t/2+t*l,d=a*(.3+l*.7),s=h.x+Math.cos(c)*d,f=h.y+Math.sin(c)*d;b.push({x:s,y:f,vx:Math.cos(c)*100,vy:Math.sin(c)*100,life:r.PARTICLE_LIFETIME*.3,maxLife:r.PARTICLE_LIFETIME*.3,size:6,color:"#fff"})}}function Jt(i){for(let a=L.length-1;a>=0;a--){const t=L[a];if(t.isEnemyProjectile){if(t.x+=t.vx*i,t.y+=t.vy*i,t.lifetime-=i,t.rotation=Math.atan2(t.vy,t.vx),t.willExplode&&t.lifetime<=t.maxLifetime*.5){for(let l=0;l<12;l++){const c=l/12*Math.PI*2,d={x:t.x,y:t.y,vx:Math.cos(c)*r.DRAGON_FIRE_SPEED*.7,vy:Math.sin(c)*r.DRAGON_FIRE_SPEED*.7,damage:r.DRAGON_FIRE_DAMAGE,lifetime:2,maxLifetime:2,radius:8,weaponId:"dragon_fire",rotation:c,trail:[],isEnemyProjectile:!0};L.push(d)}const o=Math.floor(r.PARTICLE_COUNT_EXPLOSION*te);for(let l=0;l<o;l++)b.push({x:t.x,y:t.y,vx:P(-300,300),vy:P(-300,300),life:r.PARTICLE_LIFETIME*.8,maxLife:r.PARTICLE_LIFETIME*.8,size:P(5,10),color:"#FF4500"});O=10,H=10,x("medium"),L.splice(a,1);continue}(t.lifetime<=0||t.x<-50||t.x>S+50||t.y<-50||t.y>u+50)&&L.splice(a,1);continue}if(t.weaponId==="lightning_bolt"&&t.chainCount!==void 0&&t.chainCount>0){Zt(t,i);continue}if(t.weaponId==="light_ring"){ni(t,i);continue}if(t.weaponId==="laser_strike"){li(t,i);continue}if(t.weaponId==="arcane_dart"){si(t,i);continue}t.trail.push({x:t.x,y:t.y,alpha:1}),t.trail.length>5&&t.trail.shift();for(let n=0;n<t.trail.length;n++)t.trail[n].alpha=n/t.trail.length;t.x+=t.vx*i,t.y+=t.vy*i,t.lifetime-=i,t.rotation=Math.atan2(t.vy,t.vx),(t.lifetime<=0||t.x<-50||t.x>S+50||t.y<-50||t.y>u+50)&&L.splice(a,1)}}function Zt(i,a){if(i.hitEnemies||(i.hitEnemies=new Set),M.length>0){let o=null,l=1/0;for(const c of M){const d=M.indexOf(c);if(i.hitEnemies.has(d))continue;const s=w(i.x,i.y,c.x,c.y);s<l&&(l=s,o=c)}if(o&&l<500){const c=o.x-i.x,d=o.y-i.y;if(Math.sqrt(c*c+d*d)>0){const f=Math.atan2(d,c),E=Math.atan2(i.vy,i.vx);let _=f-E;for(;_>Math.PI;)_-=Math.PI*2;for(;_<-Math.PI;)_+=Math.PI*2;const y=r.LIGHTNING_BOLT_HOMING_STRENGTH*a,R=E+Math.sign(_)*Math.min(Math.abs(_),y),g=Math.sqrt(i.vx*i.vx+i.vy*i.vy);i.vx=Math.cos(R)*g,i.vy=Math.sin(R)*g}}}i.x+=i.vx*a,i.y+=i.vy*a,i.lifetime-=a,i.rotation=Math.atan2(i.vy,i.vx),i.trail.push({x:i.x,y:i.y,alpha:1}),i.trail.length>2&&i.trail.shift();const t=i.x+Math.cos(i.rotation)*i.radius,n=i.y+Math.sin(i.rotation)*i.radius;for(let o=M.length-1;o>=0;o--){const l=M[o],c=o;if(i.hitEnemies.has(c))continue;if(w(t,n,l.x,l.y)<l.radius+i.radius){i.hitEnemies.add(c),l.hp-=i.damage;for(let f=0;f<10;f++)b.push({x:l.x,y:l.y,vx:P(-100,100),vy:P(-100,100),life:r.PARTICLE_LIFETIME*.5,maxLife:r.PARTICLE_LIFETIME*.5,size:5,color:"#00ffff"});if(_e(),l.hp<=0){ne(l),M.splice(o,1);const f=new Set;for(const E of i.hitEnemies)E<o?f.add(E):E>o&&f.add(E-1);i.hitEnemies=f}if(i.chainCount!==void 0&&i.chainCount>0&&M.length>0){let f=null,E=r.LIGHTNING_BOLT_CHAIN_RANGE;for(let _=0;_<M.length;_++){const y=M[_];if(!i.hitEnemies.has(_)){const R=w(l.x,l.y,y.x,y.y);R<E&&(E=R,f=y,i.target=y)}}if(f){i.chainCount--;const _=Math.atan2(f.y-i.y,f.x-i.x);i.vx=Math.cos(_)*r.LIGHTNING_BOLT_SPEED,i.vy=Math.sin(_)*r.LIGHTNING_BOLT_SPEED,i.rotation=_;return}}const s=L.indexOf(i);s>=0&&L.splice(s,1);return}}if(i.target)if(M.includes(i.target)){const l=Math.atan2(i.target.y-i.y,i.target.x-i.x);i.vx=Math.cos(l)*r.LIGHTNING_BOLT_SPEED,i.vy=Math.sin(l)*r.LIGHTNING_BOLT_SPEED,i.rotation=l}else if(i.chainCount!==void 0&&i.chainCount>0&&M.length>0){let l=null,c=r.LIGHTNING_BOLT_CHAIN_RANGE;for(let d=0;d<M.length;d++){const s=M[d];if(!i.hitEnemies.has(d)){const f=w(i.x,i.y,s.x,s.y);f<c&&(c=f,l=s)}}if(l){i.target=l,i.chainCount--;const d=Math.atan2(l.y-i.y,l.x-i.x);i.vx=Math.cos(d)*r.LIGHTNING_BOLT_SPEED,i.vy=Math.sin(d)*r.LIGHTNING_BOLT_SPEED,i.rotation=d}else{const d=L.indexOf(i);d>=0&&L.splice(d,1);return}}else{const l=L.indexOf(i);l>=0&&L.splice(l,1);return}if(i.lifetime<=0||i.x<-50||i.x>S+50||i.y<-50||i.y>u+50){const o=L.indexOf(i);o>=0&&L.splice(o,1)}}function jt(i){for(let a=z.length-1;a>=0;a--){const t=z[a];if(t.collected){z.splice(a,1);continue}const n=w(t.x,t.y,h.x,h.y);if(n<h.pickupRange){const o=de(h.x-t.x,h.y-t.y);t.vx=o.x*r.XP_GEM_COLLECT_SPEED,t.vy=o.y*r.XP_GEM_COLLECT_SPEED}t.x+=t.vx*i,t.y+=t.vy*i,t.rotation+=i*5,n<h.radius+t.radius&&(zt(t),z.splice(a,1))}}function zt(i){oe+=i.value,$+=i.value;for(let a=0;a<5;a++)b.push({x:i.x,y:i.y,vx:P(-50,50),vy:P(-50,50),life:r.PARTICLE_LIFETIME,maxLife:r.PARTICLE_LIFETIME,size:4,color:"#FFD700"});G.fx&&_t(),x("medium"),oe>=se&&St()}function ei(i){for(let a=ee.length-1;a>=0;a--){const t=ee[a];if(t.collected){ee.splice(a,1);continue}if(w(t.x,t.y,h.x,h.y)<h.pickupRange*1.5){const o=de(h.x-t.x,h.y-t.y);t.vx=o.x*r.CHEST_COLLECT_SPEED,t.vy=o.y*r.CHEST_COLLECT_SPEED}t.x+=t.vx*i,t.y+=t.vy*i,t.rotation+=i*2,t.pulseTime+=i*3,w(t.x,t.y,h.x,h.y)<t.radius+h.radius&&(ti(t),ee.splice(a,1))}}function ti(i){St();for(let a=0;a<20;a++)b.push({x:i.x,y:i.y,vx:P(-100,100),vy:P(-100,100),life:r.PARTICLE_LIFETIME*1.5,maxLife:r.PARTICLE_LIFETIME*1.5,size:6,color:"#FFD700"});G.fx&&_t(),x("success"),O=10,H=10}function _t(){try{const i=new(window.AudioContext||window.webkitAudioContext),a=i.createOscillator(),t=i.createGain();a.connect(t),t.connect(i.destination),a.frequency.value=800,a.type="sine",t.gain.setValueAtTime(.3,i.currentTime),t.gain.exponentialRampToValueAtTime(.01,i.currentTime+.1),a.start(i.currentTime),a.stop(i.currentTime+.1)}catch{}}function _e(){if(G.fx)try{const i=new(window.AudioContext||window.webkitAudioContext),a=i.createOscillator(),t=i.createGain();a.connect(t),t.connect(i.destination),a.frequency.value=200,a.type="sawtooth",t.gain.setValueAtTime(.2,i.currentTime),t.gain.exponentialRampToValueAtTime(.01,i.currentTime+.2),a.start(i.currentTime),a.stop(i.currentTime+.2)}catch{}}function ii(){if(G.fx)try{const i=new(window.AudioContext||window.webkitAudioContext),a=i.createOscillator(),t=i.createGain();a.connect(t),t.connect(i.destination),a.frequency.setValueAtTime(400,i.currentTime),a.frequency.setValueAtTime(600,i.currentTime+.1),a.frequency.setValueAtTime(800,i.currentTime+.2),a.type="sine",t.gain.setValueAtTime(.3,i.currentTime),t.gain.exponentialRampToValueAtTime(.01,i.currentTime+.3),a.start(i.currentTime),a.stop(i.currentTime+.3)}catch{}}function St(){console.log("[levelUp] Level up! New level:",ye+1),oe>=se?oe-=se:oe=0,ye++,se=Math.floor(r.XP_PER_LEVEL*Math.pow(r.XP_PER_LEVEL_MULTIPLIER,ye-1)),ii(),ai(),x("success")}function ai(){N="LEVEL_UP",F.classList.remove("playing"),Be.classList.remove("hidden");const a=[...yt].filter(n=>{if(n.category==="new_weapon"){const o=n.id;if(m.find(l=>l.id===o)||m.length>=3)return!1}else if(n.category==="weapon_specific"&&(n.id==="fire_ring_upgrade"&&!m.find(o=>o.id==="fire_ring")||n.id==="holy_sword_upgrade"&&!m.find(o=>o.id==="holy_sword")||n.id==="lightning_bolt_upgrade"&&!m.find(o=>o.id==="lightning_bolt")||n.id==="magic_missile_upgrade"&&!m.find(o=>o.id==="magic_missile")||n.id==="light_ring_upgrade"&&!m.find(o=>o.id==="light_ring")||n.id==="laser_strike_upgrade"&&!m.find(o=>o.id==="laser_strike")||n.id==="arcane_dart_upgrade"&&!m.find(o=>o.id==="arcane_dart")))return!1;return!0}),t=[];for(let n=0;n<4&&a.length>0;n++){const o=Math.floor(Math.random()*a.length);t.push(a[o]),a.splice(o,1)}Ue.innerHTML="",t.forEach((n,o)=>{const l=document.createElement("div");l.className="upgrade-card",l.dataset.upgradeId=n.id;let c=n.description;if(n.id==="weapon_projectiles"){const d=k+1;c=`Fire ${d+1} projectiles per shot (currently ${d})`}else n.id==="magic_missile_upgrade"?c=`Fire ${he+1} Magic Missile projectiles (currently ${he})`:n.id==="lightning_bolt_upgrade"?c=`Lightning chains ${ge+1} times (currently ${ge})`:n.id==="light_ring_upgrade"?c="Light Spinner: +25% area & +20% speed":n.id==="laser_strike_upgrade"?c=`Fire ${ue+1} simultaneous strikes (currently ${ue})`:n.id==="arcane_dart_upgrade"&&(c=`Fire ${Ee+1} darts per shot (currently ${Ee})`);l.innerHTML=`
      <div class="upgrade-card-icon">${n.icon}</div>
      <div class="upgrade-card-title">${n.name}</div>
      <div class="upgrade-card-desc">${c}</div>
    `,l.addEventListener("click",()=>{oi(n),x("light")}),Ue.appendChild(l)})}function oi(i){switch(console.log("[applyUpgrade] Applying upgrade:",i.id),Be.classList.add("hidden"),N="PLAYING",F.classList.add("playing"),Q=!1,Z=Me,j=Te,h.vx=0,h.vy=0,i.id){case"weapon_damage":W*=1.2;for(const s of m)s.damage*=1.2;break;case"weapon_fire_rate":q*=1.25;for(const s of m)s.fireRate>0&&(s.fireRate*=1.25);break;case"weapon_projectiles":k++,console.log("[applyUpgrade] Multi Shot count:",k);break;case"weapon_range":re*=1.2;for(const s of m)s.type==="melee"&&s.range?s.range*=1.2:s.type==="area"&&s.radius&&(s.radius*=1.2);break;case"player_hp":h.maxHp+=20,h.hp=Math.min(h.hp+20,h.maxHp);break;case"player_speed":h.speed*=1.15;break;case"player_pickup_range":h.pickupRange===0?h.pickupRange=r.PLAYER_PICKUP_RANGE:h.pickupRange*=1.2;break;case"magic_missile":if(m.length<3&&!m.find(s=>s.id==="magic_missile")){const s={id:"magic_missile",level:1,fireRate:r.MAGIC_MISSILE_FIRE_RATE*q,lastFireTime:-1,damage:r.MAGIC_MISSILE_DAMAGE*W,projectileSpeed:r.MAGIC_MISSILE_SPEED,projectileLifetime:r.MAGIC_MISSILE_LIFETIME,type:"projectile"};m.push(s),console.log("[applyUpgrade] Magic Missile weapon added!"),V()}else if(m.find(s=>s.id==="magic_missile")){const s=m.find(f=>f.id==="magic_missile");s&&(s.damage*=1.2,s.fireRate*=1.15,s.level++)}break;case"fire_ring":if(m.length<3&&!m.find(s=>s.id==="fire_ring"))m.push({id:"fire_ring",level:1,fireRate:0,lastFireTime:0,damage:r.FIRE_RING_DAMAGE*W,projectileSpeed:0,projectileLifetime:0,type:"area",radius:r.FIRE_RING_RADIUS*re,lastDamageTime:0}),console.log("[applyUpgrade] Fire Ring weapon added!"),V();else if(m.find(s=>s.id==="fire_ring")){const s=m.find(f=>f.id==="fire_ring");s&&(s.damage*=1.2,s.radius=(s.radius||r.FIRE_RING_RADIUS)*1.1,s.level++)}break;case"lightning_bolt":if(m.length<3&&!m.find(s=>s.id==="lightning_bolt"))m.push({id:"lightning_bolt",level:1,fireRate:r.LIGHTNING_BOLT_FIRE_RATE*q,lastFireTime:-1,damage:r.LIGHTNING_BOLT_DAMAGE*W,projectileSpeed:r.LIGHTNING_BOLT_SPEED,projectileLifetime:r.LIGHTNING_BOLT_LIFETIME,type:"projectile",sequentialShots:[]}),console.log("[applyUpgrade] Lightning Bolt weapon added!"),V();else if(m.find(s=>s.id==="lightning_bolt")){const s=m.find(f=>f.id==="lightning_bolt");s&&(s.damage*=1.2,s.fireRate*=1.15,s.level++)}break;case"holy_sword":if(m.length<3&&!m.find(s=>s.id==="holy_sword"))m.push({id:"holy_sword",level:1,fireRate:r.HOLY_SWORD_FIRE_RATE*q,lastFireTime:-1,damage:r.HOLY_SWORD_DAMAGE*W,projectileSpeed:0,projectileLifetime:0,type:"melee",range:r.HOLY_SWORD_RANGE*re,arc:r.HOLY_SWORD_ARC,sequentialShots:[]}),console.log("[applyUpgrade] Holy Sword weapon added!"),V();else if(m.find(s=>s.id==="holy_sword")){const s=m.find(f=>f.id==="holy_sword");s&&(s.damage*=1.2,s.range=(s.range||r.HOLY_SWORD_RANGE)*1.1,s.fireRate*=1.15,s.level++)}break;case"light_ring":if(m.length<3&&!m.find(s=>s.id==="light_ring"))m.push({id:"light_ring",level:1,fireRate:r.LIGHT_RING_FIRE_RATE*q,lastFireTime:-1,damage:r.LIGHT_RING_DAMAGE*W,projectileSpeed:r.LIGHT_RING_SPEED,projectileLifetime:10,type:"projectile",sequentialShots:[]}),console.log("[applyUpgrade] Light Spinner weapon added!"),V();else if(m.find(s=>s.id==="light_ring")){const s=m.find(f=>f.id==="light_ring");s&&(s.damage*=1.2,s.fireRate*=1.15,s.level++)}break;case"laser_strike":if(m.length<3&&!m.find(s=>s.id==="laser_strike"))m.push({id:"laser_strike",level:1,fireRate:r.LASER_STRIKE_FIRE_RATE*q,lastFireTime:-1,damage:r.LASER_STRIKE_DAMAGE*W,projectileSpeed:800,projectileLifetime:.3,type:"projectile"}),console.log("[applyUpgrade] Laser Strike weapon added!"),V();else if(m.find(s=>s.id==="laser_strike")){const s=m.find(f=>f.id==="laser_strike");s&&(s.damage*=1.2,s.fireRate*=1.15,s.level++)}break;case"arcane_dart":if(m.length<3&&!m.find(s=>s.id==="arcane_dart"))m.push({id:"arcane_dart",level:1,fireRate:r.ARCANE_DART_FIRE_RATE*q,lastFireTime:-1,damage:r.ARCANE_DART_DAMAGE*W,projectileSpeed:r.ARCANE_DART_SPEED,projectileLifetime:r.ARCANE_DART_LIFETIME,type:"projectile"}),console.log("[applyUpgrade] Arcane Dart weapon added!"),V();else if(m.find(s=>s.id==="arcane_dart")){const s=m.find(f=>f.id==="arcane_dart");s&&(s.damage*=1.2,s.fireRate*=1.15,s.level++)}break;case"fire_ring_upgrade":const a=m.find(s=>s.id==="fire_ring");a&&(a.damage*=1.25,a.radius=(a.radius||r.FIRE_RING_RADIUS)*1.25,a.level++,console.log("[applyUpgrade] Fire Ring upgraded! Damage:",a.damage,"Radius:",a.radius));break;case"holy_sword_upgrade":const t=m.find(s=>s.id==="holy_sword");t&&(t.arc=(t.arc||r.HOLY_SWORD_ARC)*1.3,t.level++,console.log("[applyUpgrade] Holy Sword upgraded! Arc:",t.arc));break;case"lightning_bolt_upgrade":ge++;const n=m.find(s=>s.id==="lightning_bolt");n&&(n.level++,console.log("[applyUpgrade] Lightning Bolt upgraded! Chain count:",ge));break;case"magic_missile_upgrade":he++;const o=m.find(s=>s.id==="magic_missile");o&&(o.level++,console.log("[applyUpgrade] Magic Missile upgraded! Projectile count:",he));break;case"light_ring_upgrade":Ge*=1.25,ve*=1.2,Ze*=1.2;const l=m.find(s=>s.id==="light_ring");l&&(l.level++,console.log("[applyUpgrade] Light Spinner upgraded! Radius:",Ge,"Speed:",ve));break;case"laser_strike_upgrade":ue++;const c=m.find(s=>s.id==="laser_strike");c&&(c.level++,console.log("[applyUpgrade] Laser Strike upgraded! Strike count:",ue));break;case"arcane_dart_upgrade":Ee++;const d=m.find(s=>s.id==="arcane_dart");d&&(d.level++,console.log("[applyUpgrade] Arcane Dart upgraded! Projectile count:",Ee));break}}function ni(i,a){(i.startX===void 0||i.startY===void 0||i.maxDistance===void 0)&&(i.startX=i.x,i.startY=i.y,i.maxDistance=r.LIGHT_RING_RANGE,i.isReturning=!1,i.lastDamageTime=0);const t=w(i.startX,i.startY,i.x,i.y);if(!i.isReturning&&t>=i.maxDistance&&(i.isReturning=!0),i.isReturning){const n=h.x-i.x,o=h.y-i.y;if(Math.sqrt(n*n+o*o)<i.radius+h.radius){const _=L.indexOf(i);_>=0&&L.splice(_,1);return}const c=Math.atan2(o,n),d=Ze,s=Math.atan2(i.vy,i.vx);let f=c-s;for(;f>Math.PI;)f-=Math.PI*2;for(;f<-Math.PI;)f+=Math.PI*2;const E=s+f*.2;i.vx=Math.cos(E)*d,i.vy=Math.sin(E)*d}if(i.x+=i.vx*a,i.y+=i.vy*a,i.rotation+=a*5,i.lastDamageTime===void 0&&(i.lastDamageTime=0),p-i.lastDamageTime>=r.LIGHT_RING_DAMAGE_INTERVAL){for(let n=M.length-1;n>=0;n--){const o=M[n];if(w(i.x,i.y,o.x,o.y)<i.radius+o.radius){o.hp-=i.damage,_e();const c=Math.floor(r.PARTICLE_COUNT_LIGHT_RING_HIT*te);for(let d=0;d<c;d++)b.push({x:o.x,y:o.y,vx:P(-50,50),vy:P(-50,50),life:r.PARTICLE_LIFETIME*.3,maxLife:r.PARTICLE_LIFETIME*.3,size:4,color:"#FFD700"});o.hp<=0&&(ne(o),M.splice(n,1))}}i.lastDamageTime=p}if(i.isReturning&&w(i.x,i.y,h.x,h.y)>S+u){const o=L.indexOf(i);o>=0&&L.splice(o,1)}}function li(i,a){if(i.y+=i.vy*a,i.lifetime-=a,i.target&&!i.hasStruck&&(w(i.x,i.y,i.target.x,i.target.y)<i.radius+i.target.radius||i.y>=i.target.y)){i.hasStruck=!0,i.target.hp-=i.damage,_e(),O=5,H=5,x("medium");const n=Math.floor(r.PARTICLE_COUNT_LASER_STRIKE*te);for(let o=0;o<n;o++)b.push({x:i.target.x,y:i.target.y,vx:P(-200,200),vy:P(-200,200),life:r.PARTICLE_LIFETIME*.5,maxLife:r.PARTICLE_LIFETIME*.5,size:P(4,8),color:"#00FFFF"});if(i.target.hp<=0){ne(i.target);const o=M.indexOf(i.target);o>=0&&M.splice(o,1)}}if(i.lifetime<=0){const t=L.indexOf(i);t>=0&&L.splice(t,1)}}function si(i,a){if(i.hitEnemies||(i.hitEnemies=new Set),i.bounceCount===void 0&&(i.bounceCount=0),i.maxBounces===void 0&&(i.maxBounces=10),i.x,i.y,i.x+=i.vx*a,i.y+=i.vy*a,i.lifetime-=a,i.rotation=Math.atan2(i.vy,i.vx),i.bounceCount<i.maxBounces&&((i.x-i.radius<0||i.x+i.radius>S)&&(i.vx=-i.vx,i.bounceCount++,i.x=Math.max(i.radius,Math.min(S-i.radius,i.x))),(i.y-i.radius<0||i.y+i.radius>u)&&(i.vy=-i.vy,i.bounceCount++,i.y=Math.max(i.radius,Math.min(u-i.radius,i.y)))),i.lifetime<=0||i.bounceCount>=i.maxBounces){const t=L.indexOf(i);t>=0&&L.splice(t,1)}}function ri(){for(let i=L.length-1;i>=0;i--){const a=L[i];if(!a.isEnemyProjectile&&!(a.weaponId==="light_ring"||a.weaponId==="laser_strike")){if(a.weaponId==="arcane_dart"){a.hitEnemies||(a.hitEnemies=new Set);for(let t=M.length-1;t>=0;t--){const n=M[t],o=M.indexOf(n);if(a.hitEnemies.has(o))continue;if(w(a.x,a.y,n.x,n.y)<a.radius+n.radius){a.hitEnemies.add(o),n.hp-=a.damage,_e();const c=Math.floor(r.PARTICLE_COUNT_HIT*te);for(let d=0;d<c;d++)b.push({x:n.x,y:n.y,vx:P(-100,100),vy:P(-100,100),life:r.PARTICLE_LIFETIME*.3,maxLife:r.PARTICLE_LIFETIME*.3,size:4,color:"#9370DB"});if(n.hp<=0){ne(n),M.splice(t,1);const d=new Set;for(const s of a.hitEnemies)s<t?d.add(s):s>t&&d.add(s-1);a.hitEnemies=d}}}continue}for(let t=M.length-1;t>=0;t--){const n=M[t];if(w(a.x,a.y,n.x,n.y)<a.radius+n.radius){n.hp-=a.damage,_e();for(let l=0;l<8;l++)b.push({x:n.x,y:n.y,vx:P(-100,100),vy:P(-100,100),life:r.PARTICLE_LIFETIME,maxLife:r.PARTICLE_LIFETIME,size:6,color:n.color});L.splice(i,1),n.hp<=0&&(ne(n),M.splice(t,1));break}}}}if(h.invulnerableTime<=0)for(let i=L.length-1;i>=0;i--){const a=L[i];if(!a.isEnemyProjectile)continue;w(a.x,a.y,h.x,h.y)<a.radius+h.radius&&(h.hp-=a.damage,h.invulnerableTime=r.PLAYER_INVULNERABLE_TIME,O=8,H=8,x("error"),L.splice(i,1),h.hp<=0&&at())}if(h.invulnerableTime<=0){for(const i of M)if(w(h.x,h.y,i.x,i.y)<h.radius+i.radius){h.hp-=10,h.invulnerableTime=r.PLAYER_INVULNERABLE_TIME,O=10,H=10,x("heavy"),h.hp<=0&&at();break}}}function ne(i){if($+=10,i.isBoss){if(Je++,i.isDragon||i.type==="dragon"){N="VICTORY",fe.classList.add("hidden"),ae.classList.add("hidden"),F.classList.remove("playing"),Re.classList.remove("hidden");const t=document.getElementById("victoryScore");t&&(t.textContent=$.toString()),typeof window.submitScore=="function"&&window.submitScore($),x("success");const n=Math.floor(r.PARTICLE_COUNT_VICTORY*te);for(let o=0;o<n;o++)b.push({x:i.x,y:i.y,vx:P(-400,400),vy:P(-400,400),life:r.PARTICLE_LIFETIME*2,maxLife:r.PARTICLE_LIFETIME*2,size:P(8,15),color:"#FFD700"});O=25,H=25;return}ee.push({x:i.x,y:i.y,vx:0,vy:0,collected:!1,radius:r.CHEST_RADIUS,rotation:0,pulseTime:0});const a=Math.floor(r.PARTICLE_COUNT_BOSS_DEATH*te);for(let t=0;t<a;t++)b.push({x:i.x,y:i.y,vx:P(-200,200),vy:P(-200,200),life:r.PARTICLE_LIFETIME*1.5,maxLife:r.PARTICLE_LIFETIME*1.5,size:10,color:"#FFD700"});O=15,H=15,x("heavy"),me=p}else{z.push({x:i.x,y:i.y,vx:0,vy:0,value:r.XP_GEM_VALUE,collected:!1,radius:r.XP_GEM_RADIUS,rotation:0});const a=Math.floor(r.PARTICLE_COUNT_ENEMY_DEATH*te);for(let t=0;t<a;t++)b.push({x:i.x,y:i.y,vx:P(-150,150),vy:P(-150,150),life:r.PARTICLE_LIFETIME,maxLife:r.PARTICLE_LIFETIME,size:8,color:i.color});O=5,H=5}}function ci(i){const a=p>60?2:p>30?1.5:1,t=p/r.DIFFICULTY_SCALE_INTERVAL*r.ENEMY_SPAWN_RATE_INCREASE*a,n=p>120?Math.pow((p-120)/60,1.8)*20:0,o=p>180?Math.pow((p-180)/60,2)*30:0;Qe=Math.max(r.ENEMY_SPAWN_INTERVAL_MIN,r.ENEMY_SPAWN_INTERVAL_START-t-n-o)}function di(i){for(let a=b.length-1;a>=0;a--){const t=b[a];t.x+=t.vx*i,t.y+=t.vy*i,t.vx*=.95,t.vy*=.95,t.life-=i,t.life<=0&&b.splice(a,1)}}function fi(i){O*=r.SCREEN_SHAKE_DECAY,H*=r.SCREEN_SHAKE_DECAY}function pt(){const i=h.hp/h.maxHp*100;ot.style.width=i+"%",nt.textContent="Lv "+ye,lt.textContent=$.toString();const a=Math.floor(p/60),t=Math.floor(p%60);rt.textContent=`${a}:${t.toString().padStart(2,"0")}`;const n=oe/se*100;st.style.width=n+"%",V()}function V(){be.innerHTML="";for(const i of m){const a=document.createElement("div");a.className="weapon-icon-item";let t="âš”ï¸";i.id==="magic_missile"?t="âœ¨":i.id==="fire_ring"?t="ðŸ”¥":i.id==="lightning_bolt"?t="âš¡":i.id==="holy_sword"?t="âš”ï¸":i.id==="light_ring"?t="ðŸ’«":i.id==="laser_strike"?t="â˜„ï¸":i.id==="arcane_dart"&&(t="ðŸŽ¯"),a.innerHTML=`
      <div class="weapon-icon-symbol">${t}</div>
      <div class="weapon-icon-level">Lv ${i.level}</div>
    `,be.appendChild(a)}for(let i=m.length;i<3;i++){const a=document.createElement("div");a.className="weapon-icon-item empty",a.innerHTML=`
      <div class="weapon-icon-symbol">+</div>
      <div class="weapon-icon-level">Empty</div>
    `,be.appendChild(a)}}function at(){console.log("[gameOver] Game over. Final score:",$),N="GAME_OVER",F.classList.remove("playing"),ft.textContent=$.toString(),ie.classList.remove("hidden"),fe.classList.add("hidden"),ae.classList.add("hidden"),U&&U.pause(),typeof window.submitScore=="function"&&window.submitScore($),x("error")}function hi(){console.log("[transitionToNewMap] Transitioning to new map. Bosses killed:",Je),M=[],L=[],b=[],B=(B+1)%4,K*=1.3,B===3&&(le=0,console.log("[transitionToNewMap] Volcano map reached - dragon will spawn immediately")),console.log("[transitionToNewMap] New map theme:",B,"Difficulty multiplier:",K),O=20,H=20;for(let i=0;i<100;i++)b.push({x:h.x+P(-S*.5,S*.5),y:h.y+P(-u*.5,u*.5),vx:P(-300,300),vy:P(-300,300),life:r.PARTICLE_LIFETIME*2,maxLife:r.PARTICLE_LIFETIME*2,size:P(5,15),color:B===0?"#8a2be2":B===1?"#228B22":B===2?"#DAA520":"#4169E1"});x("success")}function gi(){const i=B===0?"#1a0a2e":B===1?"#0a1a0a":B===2?"#2a1a0a":"#1a0a0a";e.fillStyle=i,e.fillRect(0,0,S,u),e.save(),e.translate(O,H),ui(),(N==="PLAYING"||N==="LEVEL_UP")&&(bi(),vi(),yi(),Ii(),Mi(),xi(),wi()),e.restore()}function ui(){B===0?Ei():B===1?_i():B===2?Si():pi()}function Ei(){if(J)e.fillStyle="#1a0a2e",e.fillRect(0,0,S,u*.7),e.fillStyle="#0f080f",e.fillRect(0,u*.7,S,u*.3);else{const g=e.createLinearGradient(0,0,0,u*.7);g.addColorStop(0,"#0a0515"),g.addColorStop(.3,"#1a0a2e"),g.addColorStop(.6,"#251842"),g.addColorStop(1,"#2d1b4e"),e.fillStyle=g,e.fillRect(0,0,S,u*.7);const I=e.createLinearGradient(0,u*.7,0,u);I.addColorStop(0,"#2d1b4e"),I.addColorStop(.3,"#1a0f1a"),I.addColorStop(1,"#0f080f"),e.fillStyle=I,e.fillRect(0,u*.7,S,u*.3)}e.fillStyle="rgba(255, 255, 255, 0.6)",Pe&&(e.shadowBlur=3,e.shadowColor="rgba(255, 255, 255, 0.8)");const i=Y?20:40;for(let g=0;g<i;g++){const I=g*97.3,T=(Math.sin(I)*.5+.5)*S,A=(Math.cos(I*1.3)*.5+.5)*(u*.6),C=Math.sin(p*.5+I)*.3+.7,D=1+Math.sin(p*.8+I)*.5;e.globalAlpha=C,e.beginPath(),e.arc(T,A,D,0,Math.PI*2),e.fill()}e.shadowBlur=0,e.globalAlpha=1;const a=S*.85,t=u*.15,n=Math.min(S,u)*.08;if(!J){const g=e.createRadialGradient(a,t,n*.5,a,t,n*2);g.addColorStop(0,"rgba(255, 255, 200, 0.3)"),g.addColorStop(1,"rgba(255, 255, 200, 0)"),e.fillStyle=g,e.beginPath(),e.arc(a,t,n*2,0,Math.PI*2),e.fill()}e.fillStyle="rgba(240, 240, 200, 0.9)",Pe&&(e.shadowBlur=10,e.shadowColor="rgba(255, 255, 200, 0.5)"),e.beginPath(),e.arc(a,t,n,0,Math.PI*2),e.fill(),e.shadowBlur=0,e.fillStyle="rgba(200, 200, 180, 0.4)",e.beginPath(),e.arc(a-n*.3,t-n*.2,n*.15,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(a+n*.2,t+n*.3,n*.1,0,Math.PI*2),e.fill(),e.fillStyle="rgba(20, 10, 30, 0.8)",e.beginPath(),e.moveTo(0,u*.5);const o=8;for(let g=0;g<=o;g++){const I=g/o*S,T=u*.5,A=u*.15+Math.sin(g*2.3)*u*.05,C=T-A;if(g===0)e.lineTo(I,C);else{const D=(I+(g-1)/o*S)/2;e.quadraticCurveTo(D,C,I,C)}}e.lineTo(S,u*.5),e.lineTo(S,u*.7),e.lineTo(0,u*.7),e.closePath(),e.fill();const l=(g,I,T,A,C)=>{e.fillStyle="rgba(15, 8, 20, 0.7)",e.fillRect(g-T/2,I-A,T,A);const D=T*.3,v=A*.1;e.fillRect(g-T/2,I-A-v,D,v),e.fillRect(g-T/2+T-D,I-A-v,D,v),C&&(e.fillStyle="rgba(138, 43, 226, 0.4)",e.fillRect(g-T*.1,I-A-v-A*.15,T*.2,A*.15))},c=[{x:S*.15,width:S*.08,height:u*.12,hasFlag:!0},{x:S*.35,width:S*.1,height:u*.15,hasFlag:!1},{x:S*.65,width:S*.09,height:u*.13,hasFlag:!0},{x:S*.85,width:S*.08,height:u*.11,hasFlag:!1}];for(const g of c)l(g.x,u*.7,g.width,g.height,g.hasFlag);e.fillStyle="rgba(15, 8, 20, 0.6)";const d=u*.05,s=u*.7-d;e.fillRect(c[0].x+c[0].width/2,s,c[1].x-c[1].width/2-(c[0].x+c[0].width/2),d),e.fillRect(c[1].x+c[1].width/2,s,c[2].x-c[2].width/2-(c[1].x+c[1].width/2),d),e.fillRect(c[2].x+c[2].width/2,s,c[3].x-c[3].width/2-(c[2].x+c[2].width/2),d),e.strokeStyle="rgba(100, 50, 50, 0.1)",e.lineWidth=1;const f=4;for(let g=u*.7;g<u;g+=f){e.beginPath(),e.moveTo(0,g);const I=Math.sin(g/f*.5+p*.1)*2;e.lineTo(S,g+I),e.stroke()}const E=20;e.shadowBlur=8,e.shadowColor="rgba(138, 43, 226, 0.6)";for(let g=0;g<E;g++){const I=g*137.5,T=(S*.5+Math.sin(p*.2+I)*S*.45)%S,A=(u*.5+Math.cos(p*.25+I)*u*.45)%(u*.65),C=.4+Math.sin(p*1.8+I)*.3,D=2.5+Math.sin(p*1.2+I)*1.5;e.fillStyle=`rgba(138, 43, 226, ${C})`,e.beginPath(),e.arc(T,A,D,0,Math.PI*2),e.fill()}e.shadowBlur=0,e.strokeStyle="rgba(138, 43, 226, 0.08)",e.lineWidth=1;const _=100,y=p*15%_,R=p*15%_;for(let g=-y;g<S+_;g+=_)e.beginPath(),e.moveTo(g,0),e.lineTo(g,u*.7),e.stroke();for(let g=-R;g<u*.7+_;g+=_)e.beginPath(),e.moveTo(0,g),e.lineTo(S,g),e.stroke();if(J)e.fillStyle="rgba(138, 43, 226, 0.1)",e.fillRect(0,u*.6,S,u*.15);else{const g=e.createLinearGradient(0,u*.6,0,u*.75);g.addColorStop(0,"rgba(138, 43, 226, 0)"),g.addColorStop(.5,"rgba(138, 43, 226, 0.15)"),g.addColorStop(1,"rgba(138, 43, 226, 0.25)"),e.fillStyle=g,e.fillRect(0,u*.6,S,u*.15)}}function _i(){if(J)e.fillStyle="#98D8E8",e.fillRect(0,0,S,u*.7),e.fillStyle="#1a3d0a",e.fillRect(0,u*.7,S,u*.3);else{const o=e.createLinearGradient(0,0,0,u*.7);o.addColorStop(0,"#87CEEB"),o.addColorStop(.5,"#98D8E8"),o.addColorStop(1,"#B0E0E6"),e.fillStyle=o,e.fillRect(0,0,S,u*.7);const l=e.createLinearGradient(0,u*.7,0,u);l.addColorStop(0,"#2d5016"),l.addColorStop(.5,"#1a3d0a"),l.addColorStop(1,"#0f2505"),e.fillStyle=l,e.fillRect(0,u*.7,S,u*.3)}e.fillStyle="rgba(34, 139, 34, 0.6)";const i=Y?8:12;for(let o=0;o<i;o++){const l=o*73.7,c=(Math.sin(l)*.5+.5)*S,d=u*.65,s=u*.15+Math.sin(l*1.3)*u*.05,f=S*.04+Math.sin(l*.7)*S*.02;e.fillRect(c-f*.15,d-s*.3,f*.3,s*.3),e.beginPath(),e.arc(c,d-s*.3,f*.6,0,Math.PI*2),e.fill()}const a=S*.15,t=u*.2,n=Math.min(S,u)*.06;if(!J){const o=e.createRadialGradient(a,t,n*.5,a,t,n*2);o.addColorStop(0,"rgba(255, 255, 200, 0.5)"),o.addColorStop(1,"rgba(255, 255, 200, 0)"),e.fillStyle=o,e.beginPath(),e.arc(a,t,n*2,0,Math.PI*2),e.fill()}e.fillStyle="#FFD700",e.beginPath(),e.arc(a,t,n,0,Math.PI*2),e.fill(),Pe&&(e.shadowBlur=5,e.shadowColor="rgba(34, 139, 34, 0.5)");for(let o=0;o<30;o++){const l=o*97.3,c=(S*.5+Math.sin(p*.15+l)*S*.45)%S,d=(u*.5+Math.cos(p*.2+l)*u*.45)%(u*.65),s=.3+Math.sin(p*1.5+l)*.2;e.fillStyle=`rgba(34, 139, 34, ${s})`,e.beginPath(),e.arc(c,d,3,0,Math.PI*2),e.fill()}e.shadowBlur=0}function Si(){const i=e.createLinearGradient(0,0,0,u*.7);i.addColorStop(0,"#FF6347"),i.addColorStop(.3,"#FF8C00"),i.addColorStop(.6,"#FFA500"),i.addColorStop(1,"#FFD700"),e.fillStyle=i,e.fillRect(0,0,S,u*.7);const a=e.createLinearGradient(0,u*.7,0,u);a.addColorStop(0,"#DAA520"),a.addColorStop(.5,"#CD853F"),a.addColorStop(1,"#8B4513"),e.fillStyle=a,e.fillRect(0,u*.7,S,u*.3),e.fillStyle="rgba(139, 69, 19, 0.4)",e.beginPath(),e.moveTo(0,u*.7);const t=6;for(let d=0;d<=t;d++){const s=d/t*S,f=u*.7,E=u*.08+Math.sin(d*1.5)*u*.03,_=f-E;if(d===0)e.lineTo(s,_);else{const y=(s+(d-1)/t*S)/2;e.quadraticCurveTo(y,_,s,_)}}e.lineTo(S,u*.7),e.closePath(),e.fill();const n=S*.5,o=u*.25,l=Math.min(S,u)*.12;if(!J){const d=e.createRadialGradient(n,o,l*.5,n,o,l*3);d.addColorStop(0,"rgba(255, 215, 0, 0.6)"),d.addColorStop(1,"rgba(255, 140, 0, 0)"),e.fillStyle=d,e.beginPath(),e.arc(n,o,l*3,0,Math.PI*2),e.fill()}e.fillStyle="#FF8C00",e.beginPath(),e.arc(n,o,l,0,Math.PI*2),e.fill(),e.fillStyle="rgba(34, 139, 34, 0.7)";const c=[{x:S*.2,height:u*.1},{x:S*.4,height:u*.12},{x:S*.7,height:u*.09},{x:S*.85,height:u*.11}];for(const d of c){const s=u*.7,f=S*.02;e.fillRect(d.x-f/2,s-d.height,f,d.height),e.fillRect(d.x-f*.8,s-d.height*.6,f*.6,d.height*.4),e.fillRect(d.x+f*.2,s-d.height*.7,f*.6,d.height*.4)}e.shadowBlur=3,e.shadowColor="rgba(218, 165, 32, 0.4)";for(let d=0;d<25;d++){const s=d*137.5,f=(S*.5+Math.sin(p*.3+s)*S*.45)%S,E=u*.7+Math.sin(p*.4+s)*u*.2,_=.4+Math.sin(p*2+s)*.3;e.fillStyle=`rgba(218, 165, 32, ${_})`,e.beginPath(),e.arc(f,E,2,0,Math.PI*2),e.fill()}e.shadowBlur=0}function pi(){const i=e.createLinearGradient(0,0,0,u*.7);i.addColorStop(0,"#1a0a0a"),i.addColorStop(.3,"#4a1a1a"),i.addColorStop(.6,"#6a2a2a"),i.addColorStop(1,"#8B0000"),e.fillStyle=i,e.fillRect(0,0,S,u*.7);const a=e.createLinearGradient(0,u*.7,0,u);a.addColorStop(0,"#2a1a1a"),a.addColorStop(.5,"#1a0a0a"),a.addColorStop(1,"#0a0505"),e.fillStyle=a,e.fillRect(0,u*.7,S,u*.3),e.strokeStyle="rgba(255, 69, 0, 0.6)",e.lineWidth=3,e.shadowBlur=10,e.shadowColor="#FF4500";const t=5;for(let l=0;l<t;l++){const c=l*47.3;e.beginPath(),e.moveTo(0,u*.75+Math.sin(c)*u*.1);for(let d=0;d<=S;d+=20){const s=u*.75+Math.sin(d*.01+c+p*.5)*u*.08;e.lineTo(d,s)}e.stroke()}e.shadowBlur=0,e.fillStyle="rgba(40, 20, 20, 0.9)",e.beginPath(),e.moveTo(0,u*.5);const n=6;for(let l=0;l<=n;l++){const c=l/n*S,d=u*.5,s=u*.2+Math.sin(l*2.1)*u*.08,f=d-s;if(l===0)e.lineTo(c,f);else{const E=(c+(l-1)/n*S)/2;e.quadraticCurveTo(E,f,c,f)}}e.lineTo(S,u*.5),e.lineTo(S,u*.7),e.lineTo(0,u*.7),e.closePath(),e.fill(),Pe&&(e.shadowBlur=8,e.shadowColor="#FF4500");const o=Y?20:40;for(let l=0;l<o;l++){const c=l*97.3,d=(S*.5+Math.sin(p*.25+c)*S*.45)%S,s=(u*.5+Math.cos(p*.3+c)*u*.45)%(u*.65),f=.5+Math.sin(p*2+c)*.4,E=3+Math.sin(p*1.5+c)*2;e.fillStyle=`rgba(255, 69, 0, ${f})`,e.beginPath(),e.arc(d,s,E,0,Math.PI*2),e.fill()}e.shadowBlur=0}function Ii(){if(e.save(),e.translate(h.x,h.y),h.invulnerableTime<=0)e.shadowBlur=20,e.shadowColor="#8a2be2";else if(!(Math.sin(h.invulnerableTime*20)>0)){e.restore();return}let i=0;(h.vx!==0||h.vy!==0)&&(i=Math.atan2(h.vy,h.vx));const a=h.radius,t=e.createLinearGradient(-a*.6,-a,a*.6,a);t.addColorStop(0,"#5a1a7a"),t.addColorStop(.3,"#6a1b9a"),t.addColorStop(.5,"#8a2be2"),t.addColorStop(.7,"#9a3bf2"),t.addColorStop(1,"#4a0a6a"),e.fillStyle=t,e.beginPath(),e.moveTo(-a*.4,-a*.3),e.lineTo(a*.4,-a*.3),e.quadraticCurveTo(a*.5,a*.6,a*.6,a*.8),e.lineTo(-a*.6,a*.8),e.quadraticCurveTo(-a*.5,a*.6,-a*.4,-a*.3),e.closePath(),e.fill(),e.fillStyle="rgba(255, 255, 255, 0.1)",e.beginPath(),e.moveTo(-a*.3,-a*.2),e.lineTo(a*.3,-a*.2),e.lineTo(a*.4,a*.4),e.lineTo(-a*.4,a*.4),e.closePath(),e.fill(),e.strokeStyle="#a855f7",e.lineWidth=2,e.beginPath(),e.moveTo(-a*.4,-a*.3),e.lineTo(a*.4,-a*.3),e.stroke();const n=e.createRadialGradient(-a*.1,-a*.6,0,0,-a*.5,a*.3);n.addColorStop(0,"#ffeddb"),n.addColorStop(1,"#ffdbac"),e.fillStyle=n,e.beginPath(),e.arc(0,-a*.5,a*.3,0,Math.PI*2),e.fill(),e.strokeStyle="#e6c99a",e.lineWidth=1,e.beginPath(),e.arc(0,-a*.5,a*.3,0,Math.PI*2),e.stroke();const o=e.createLinearGradient(0,-a*1.2,0,-a*.5);o.addColorStop(0,"#3a0a6c"),o.addColorStop(.5,"#4a148c"),o.addColorStop(1,"#5a1a9a"),e.fillStyle=o,e.beginPath(),e.moveTo(-a*.25,-a*.5),e.lineTo(a*.25,-a*.5),e.lineTo(0,-a*1.2),e.closePath(),e.fill(),e.fillStyle="#a855f7",e.shadowBlur=5,e.shadowColor="#a855f7";for(let f=0;f<3;f++){const E=(f-1)*a*.15,_=-a*.7-f*a*.15;e.beginPath(),e.arc(E,_,2,0,Math.PI*2),e.fill()}e.shadowBlur=0,e.fillStyle="#8a2be2",e.fillRect(-a*.25,-a*.55,a*.5,a*.08),e.strokeStyle="#a855f7",e.lineWidth=1,e.strokeRect(-a*.25,-a*.55,a*.5,a*.08),e.shadowBlur=6,e.shadowColor="#8a2be2",e.fillStyle="#4a148c",e.beginPath(),e.arc(-a*.1,-a*.55,a*.06,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(a*.1,-a*.55,a*.06,0,Math.PI*2),e.fill(),e.shadowBlur=0,e.fillStyle="#a855f7",e.beginPath(),e.arc(-a*.1,-a*.56,a*.02,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(a*.1,-a*.56,a*.02,0,Math.PI*2),e.fill(),e.save(),e.rotate(i);const l=e.createLinearGradient(a*.4,-a*.2,a*.7,a*.3);l.addColorStop(0,"#6B4423"),l.addColorStop(.5,"#8B4513"),l.addColorStop(1,"#A0522D"),e.strokeStyle=l,e.lineWidth=4,e.lineCap="round",e.beginPath(),e.moveTo(a*.4,-a*.2),e.lineTo(a*.7,a*.3),e.stroke(),e.strokeStyle="#5a2a13",e.lineWidth=1;for(let f=0;f<3;f++){const E=f/3,_=a*.4+a*.3*E,y=-a*.2+a*.5*E,R=a*.4+a*.3*(E+.1),g=-a*.2+a*.5*(E+.1);e.beginPath(),e.moveTo(_,y),e.lineTo(R,g),e.stroke()}const c=1+Math.sin(h.animationTime*3)*.1;if(Pe&&(e.shadowBlur=15,e.shadowColor="#8a2be2"),J)e.fillStyle="#8a2be2",e.beginPath(),e.arc(a*.7,a*.3,a*.15*c,0,Math.PI*2),e.fill();else{const f=e.createRadialGradient(a*.7,a*.3,0,a*.7,a*.3,a*.15*c);f.addColorStop(0,"#fff"),f.addColorStop(.3,"#c485f7"),f.addColorStop(.6,"#a855f7"),f.addColorStop(1,"#8a2be2"),e.fillStyle=f,e.beginPath(),e.arc(a*.7,a*.3,a*.15*c,0,Math.PI*2),e.fill()}e.shadowBlur=0,e.fillStyle="#fff",e.beginPath(),e.arc(a*.7,a*.3,a*.08,0,Math.PI*2),e.fill(),Y||(e.fillStyle="rgba(255, 255, 255, 0.6)",e.beginPath(),e.arc(a*.68,a*.28,a*.04,0,Math.PI*2),e.fill()),e.restore();const d=h.animationTime,s=Y?2:3;for(let f=0;f<s;f++){const E=d+f*Math.PI*2/s+i,_=a*.5,y=Math.cos(E)*_,R=Math.sin(E)*_;e.fillStyle=`rgba(255, 255, 255, ${.7+Math.sin(d*2+f)*.3})`,e.beginPath(),e.arc(y,R,2,0,Math.PI*2),e.fill()}e.restore()}function yi(){for(const i of M){e.save(),e.translate(i.x,i.y),e.scale(i.scale,i.scale),Math.cos(i.angle)<0&&e.scale(-1,1);const t=i.radius,n=i.animationTime;if(i.type==="basic"){if(J)e.fillStyle=i.color,e.beginPath(),e.ellipse(0,t*.2,t*.6,t*.8,0,0,Math.PI*2),e.fill(),e.fillStyle="#6B3513",e.beginPath(),e.arc(0,-t*.3,t*.4,0,Math.PI*2),e.fill();else{const d=e.createRadialGradient(0,t*.2,0,0,t*.2,t*.8);d.addColorStop(0,"#9B5533"),d.addColorStop(.5,i.color),d.addColorStop(1,"#6B3513"),e.fillStyle=d,e.beginPath(),e.ellipse(0,t*.2,t*.6,t*.8,0,0,Math.PI*2),e.fill(),e.fillStyle="rgba(255, 255, 255, 0.1)",e.beginPath(),e.ellipse(0,t*.1,t*.4,t*.5,0,0,Math.PI*2),e.fill();const s=e.createRadialGradient(-t*.1,-t*.4,0,0,-t*.3,t*.4);s.addColorStop(0,"#9B5533"),s.addColorStop(1,"#6B3513"),e.fillStyle=s,e.beginPath(),e.arc(0,-t*.3,t*.4,0,Math.PI*2),e.fill()}e.strokeStyle="#5a2513",e.lineWidth=2,e.beginPath(),e.arc(0,-t*.3,t*.4,0,Math.PI*2),e.stroke();const o=1+Math.sin(n*4)*.2;e.shadowBlur=10,e.shadowColor="#ff0000",e.fillStyle="#ff0000",e.beginPath(),e.arc(-t*.15,-t*.35,t*.08*o,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t*.15,-t*.35,t*.08*o,0,Math.PI*2),e.fill(),e.shadowBlur=0,e.fillStyle="#ff6666",e.beginPath(),e.arc(-t*.14,-t*.36,t*.03,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t*.14,-t*.36,t*.03,0,Math.PI*2),e.fill();const l=Math.sin(n)*.3,c=e.createLinearGradient(-t*.4,t*.1,-t*.7,t*.1+Math.cos(l)*t*.3);c.addColorStop(0,i.color),c.addColorStop(1,"#6B3513"),e.strokeStyle=c,e.lineWidth=5,e.lineCap="round",e.beginPath(),e.moveTo(-t*.4,t*.1),e.lineTo(-t*.7,t*.1+Math.cos(l)*t*.3),e.stroke(),e.beginPath(),e.moveTo(t*.4,t*.1),e.lineTo(t*.7,t*.1+Math.cos(l+Math.PI)*t*.3),e.stroke(),e.fillStyle="#1a1a1a",e.shadowBlur=3,e.shadowColor="#333";for(let d=0;d<3;d++){const s=-t*.7+d*t*.15,f=t*.4;e.beginPath(),e.moveTo(s,f),e.lineTo(s-2,f+4),e.lineTo(s+2,f+4),e.closePath(),e.fill(),e.beginPath(),e.moveTo(t*.7-d*t*.15,f),e.lineTo(t*.7-d*t*.15-2,f+4),e.lineTo(t*.7-d*t*.15+2,f+4),e.closePath(),e.fill()}e.shadowBlur=0}else if(i.type==="fast"){const o=e.createRadialGradient(0,0,0,0,0,t*.7);o.addColorStop(0,"#ff8566"),o.addColorStop(.5,i.color),o.addColorStop(1,"#cc4a37"),e.fillStyle=o,e.beginPath(),e.ellipse(0,0,t*.5,t*.7,0,0,Math.PI*2),e.fill(),e.fillStyle="rgba(255, 255, 255, 0.15)",e.beginPath(),e.ellipse(0,-t*.1,t*.3,t*.4,0,0,Math.PI*2),e.fill();const l=e.createRadialGradient(-t*.08,-t*.5,0,0,-t*.4,t*.3);l.addColorStop(0,"#9B5533"),l.addColorStop(1,"#6B3513"),e.fillStyle=l,e.beginPath(),e.arc(0,-t*.4,t*.3,0,Math.PI*2),e.fill(),e.strokeStyle="#5a2513",e.lineWidth=1.5,e.beginPath(),e.arc(0,-t*.4,t*.3,0,Math.PI*2),e.stroke(),e.shadowBlur=8,e.shadowColor="#ff6347",e.fillStyle="#ff6347",e.beginPath(),e.arc(-t*.1,-t*.45,t*.06,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t*.1,-t*.45,t*.06,0,Math.PI*2),e.fill(),e.shadowBlur=0,e.fillStyle="#ffaa88",e.beginPath(),e.arc(-t*.09,-t*.46,t*.02,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t*.09,-t*.46,t*.02,0,Math.PI*2),e.fill(),e.strokeStyle="rgba(255, 255, 255, 0.6)",e.lineWidth=2,e.lineCap="round";for(let c=0;c<4;c++){const d=(n*3+c*.25)%1,s=1-d;e.globalAlpha=s*.6,e.beginPath(),e.moveTo(t*.8,-t*.3+c*t*.15),e.lineTo(t*1.3+d*t*.6,-t*.3+c*t*.15),e.stroke()}e.globalAlpha=1}else if(i.type==="tank"){for(let d=0;d<3;d++){const s=-t*.5+d*t*.4,f=e.createRadialGradient(0,s,0,0,s,t*.7);f.addColorStop(0,"#4F6F6F"),f.addColorStop(.3,"#2F4F4F"),f.addColorStop(.7,"#1F2F2F"),f.addColorStop(1,"#0F1F1F"),e.fillStyle=f,e.beginPath(),e.arc(0,s,t*.7,0,Math.PI*2),e.fill(),e.fillStyle="rgba(255, 255, 255, 0.1)",e.beginPath(),e.arc(-t*.2,s-t*.2,t*.3,0,Math.PI*2),e.fill(),e.fillStyle="#1a1a1a";for(let E=0;E<4;E++){const _=E/4*Math.PI*2,y=Math.cos(_)*t*.5,R=s+Math.sin(_)*t*.3;e.beginPath(),e.arc(y,R,2,0,Math.PI*2),e.fill()}}const o=e.createRadialGradient(0,0,0,0,0,t*.8);o.addColorStop(0,"#3F5F5F"),o.addColorStop(.5,i.color),o.addColorStop(1,"#1F2F2F"),e.fillStyle=o,e.beginPath(),e.arc(0,0,t*.8,0,Math.PI*2),e.fill();const l=e.createRadialGradient(-t*.15,-t*.7,0,0,-t*.6,t*.5);l.addColorStop(0,"#2a2a2a"),l.addColorStop(1,"#0a0a0a"),e.fillStyle=l,e.beginPath(),e.arc(0,-t*.6,t*.5,0,Math.PI*2),e.fill(),e.strokeStyle="#1a1a1a",e.lineWidth=2,e.beginPath(),e.arc(0,-t*.6,t*.5,0,Math.PI*2),e.stroke();const c=1+Math.sin(n*3)*.15;e.shadowBlur=15,e.shadowColor="#ff0000",e.fillStyle="#ff0000",e.beginPath(),e.arc(-t*.2,-t*.65,t*.1*c,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t*.2,-t*.65,t*.1*c,0,Math.PI*2),e.fill(),e.shadowBlur=0,e.fillStyle="#ff6666",e.beginPath(),e.arc(-t*.2,-t*.65,t*.04,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t*.2,-t*.65,t*.04,0,Math.PI*2),e.fill();for(let d=0;d<5;d++){const s=d/5*Math.PI*2,f=Math.cos(s)*t*.7,E=Math.sin(s)*t*.7,_=e.createLinearGradient(f,E,f+Math.cos(s)*t*.2,E+Math.sin(s)*t*.2);_.addColorStop(0,"#2a2a2a"),_.addColorStop(1,"#0a0a0a"),e.fillStyle=_,e.beginPath(),e.moveTo(f,E),e.lineTo(f+Math.cos(s)*t*.2,E+Math.sin(s)*t*.2),e.lineTo(f+Math.cos(s+.3)*t*.15,E+Math.sin(s+.3)*t*.15),e.closePath(),e.fill(),e.fillStyle="rgba(255, 255, 255, 0.2)",e.beginPath(),e.moveTo(f,E),e.lineTo(f+Math.cos(s)*t*.15,E+Math.sin(s)*t*.15),e.lineTo(f+Math.cos(s-.2)*t*.1,E+Math.sin(s-.2)*t*.1),e.closePath(),e.fill()}}else if(i.type==="ranged"){const o=e.createLinearGradient(-t*.5,-t*.3,t*.5,t*.9);o.addColorStop(0,"#a885db"),o.addColorStop(.5,i.color),o.addColorStop(1,"#6a4a9a"),e.fillStyle=o,e.beginPath(),e.ellipse(0,t*.2,t*.5,t*.7,0,0,Math.PI*2),e.fill(),e.fillStyle="rgba(255, 255, 255, 0.1)",e.beginPath(),e.ellipse(0,t*.1,t*.3,t*.4,0,0,Math.PI*2),e.fill(),e.strokeStyle="#a855f7",e.lineWidth=2,e.beginPath(),e.ellipse(0,t*.2,t*.5,t*.7,0,0,Math.PI*2),e.stroke();const l=e.createRadialGradient(-t*.1,-t*.4,0,0,-t*.3,t*.35);l.addColorStop(0,"#9B5533"),l.addColorStop(1,"#6B3513"),e.fillStyle=l,e.beginPath(),e.arc(0,-t*.3,t*.35,0,Math.PI*2),e.fill(),e.strokeStyle="#5a2513",e.lineWidth=1.5,e.beginPath(),e.arc(0,-t*.3,t*.35,0,Math.PI*2),e.stroke();const c=1+Math.sin(n*4)*.2;e.shadowBlur=12,e.shadowColor="#9370DB",e.fillStyle="#9370DB",e.beginPath(),e.arc(-t*.12,-t*.35,t*.08*c,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t*.12,-t*.35,t*.08*c,0,Math.PI*2),e.fill(),e.shadowBlur=0,e.fillStyle="#c485f7",e.beginPath(),e.arc(-t*.11,-t*.36,t*.03,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t*.11,-t*.36,t*.03,0,Math.PI*2),e.fill(),e.save(),e.rotate(i.angle);const d=e.createLinearGradient(t*.3,-t*.2,t*.7,t*.2);d.addColorStop(0,"#6B4423"),d.addColorStop(.5,"#8B4513"),d.addColorStop(1,"#A0522D"),e.strokeStyle=d,e.lineWidth=3,e.lineCap="round",e.beginPath(),e.moveTo(t*.3,-t*.2),e.lineTo(t*.7,t*.2),e.stroke();const s=1+Math.sin(n*5)*.15;e.shadowBlur=15,e.shadowColor="#9370DB";const f=e.createRadialGradient(t*.7,t*.2,0,t*.7,t*.2,t*.12*s);f.addColorStop(0,"#fff"),f.addColorStop(.4,"#c485f7"),f.addColorStop(.7,"#9370DB"),f.addColorStop(1,"#6a4a9a"),e.fillStyle=f,e.beginPath(),e.arc(t*.7,t*.2,t*.12*s,0,Math.PI*2),e.fill(),e.shadowBlur=0,e.fillStyle="#fff",e.beginPath(),e.arc(t*.7,t*.2,t*.05,0,Math.PI*2),e.fill(),e.restore()}else if(i.type==="boss"){const o=1+Math.sin(n*2)*.1;e.shadowBlur=40*o,e.shadowColor=i.color;for(let s=0;s<3;s++){const f=t*(1-s*.15),E=1-s*.25;e.globalAlpha=E;const _=e.createRadialGradient(0,0,0,0,0,f*.9);_.addColorStop(0,"#ec2c4c"),_.addColorStop(.3,i.color),_.addColorStop(.7,"#bc0c2c"),_.addColorStop(1,"#8c000c"),e.fillStyle=_,e.beginPath(),e.arc(0,0,f*.9,0,Math.PI*2),e.fill(),e.fillStyle="rgba(255, 255, 255, 0.1)",e.beginPath(),e.arc(-f*.2,-f*.2,f*.4,0,Math.PI*2),e.fill();for(let y=0;y<6;y++){const R=y/6*Math.PI*2,g=Math.cos(R)*f*.6,I=Math.sin(R)*f*.6,T=e.createRadialGradient(g,I,0,g,I,f*.2);T.addColorStop(0,"#9B0000"),T.addColorStop(.5,"#8B0000"),T.addColorStop(1,"#5B0000"),e.fillStyle=T,e.beginPath(),e.arc(g,I,f*.2,0,Math.PI*2),e.fill(),e.fillStyle="rgba(255, 255, 255, 0.15)",e.beginPath(),e.arc(g-f*.05,I-f*.05,f*.1,0,Math.PI*2),e.fill(),e.fillStyle="#1a1a1a";for(let A=0;A<3;A++){const C=R+(A-1)*.3,D=g+Math.cos(C)*f*.1,v=I+Math.sin(C)*f*.1;e.beginPath(),e.arc(D,v,3,0,Math.PI*2),e.fill()}}}e.globalAlpha=1,e.shadowBlur=0;const l=e.createRadialGradient(-t*.2,-t*.6,0,0,-t*.5,t*.6);l.addColorStop(0,"#2a1a1a"),l.addColorStop(.5,"#1a0a0a"),l.addColorStop(1,"#0a0000"),e.fillStyle=l,e.beginPath(),e.arc(0,-t*.5,t*.6,0,Math.PI*2),e.fill(),e.strokeStyle="#1a0000",e.lineWidth=3,e.beginPath(),e.arc(0,-t*.5,t*.6,0,Math.PI*2),e.stroke();const c=1+Math.sin(n*4)*.3;e.shadowBlur=20,e.shadowColor="#ff0000";const d=e.createRadialGradient(-t*.25,-t*.55,0,-t*.25,-t*.55,t*.15*c);d.addColorStop(0,"#fff"),d.addColorStop(.3,"#ff6666"),d.addColorStop(.7,"#ff0000"),d.addColorStop(1,"#990000"),e.fillStyle=d,e.beginPath(),e.arc(-t*.25,-t*.55,t*.15*c,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t*.25,-t*.55,t*.15*c,0,Math.PI*2),e.fill(),e.shadowBlur=0,e.fillStyle="#fff",e.beginPath(),e.arc(-t*.25,-t*.55,t*.05,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t*.25,-t*.55,t*.05,0,Math.PI*2),e.fill();for(let s=0;s<8;s++){const f=s/8*Math.PI*2,E=Math.cos(f)*t*.8,_=Math.sin(f)*t*.8,y=e.createLinearGradient(E,_,E+Math.cos(f)*t*.3,_+Math.sin(f)*t*.3);y.addColorStop(0,"#2a1a1a"),y.addColorStop(.5,"#1a0a0a"),y.addColorStop(1,"#0a0000"),e.fillStyle=y,e.beginPath(),e.moveTo(E,_),e.lineTo(E+Math.cos(f)*t*.3,_+Math.sin(f)*t*.3),e.lineTo(E+Math.cos(f+.2)*t*.25,_+Math.sin(f+.2)*t*.25),e.closePath(),e.fill(),e.fillStyle="rgba(255, 255, 255, 0.2)",e.beginPath(),e.moveTo(E,_),e.lineTo(E+Math.cos(f)*t*.2,_+Math.sin(f)*t*.2),e.lineTo(E+Math.cos(f-.15)*t*.15,_+Math.sin(f-.15)*t*.15),e.closePath(),e.fill()}e.strokeStyle="rgba(220, 20, 60, 0.4)",e.lineWidth=3,e.shadowBlur=10,e.shadowColor="#DC143C";for(let s=0;s<3;s++){const f=n+s*Math.PI*2/3;e.beginPath(),e.arc(Math.cos(f)*t*.3,Math.sin(f)*t*.3,t*.4,0,Math.PI*2),e.stroke()}e.shadowBlur=0}else(i.type==="dragon"||i.isDragon)&&mi(i,n,t);if(e.restore(),i.hp<i.maxHp||i.isBoss||i.isDragon){const o=i.radius*2,l=i.isBoss||i.isDragon?6:4,c=i.x-o/2,d=i.y-i.radius-(i.isBoss||i.isDragon?18:12);e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(c,d,o,l);const s=i.isDragon?"#FF4500":i.isBoss?"#DC143C":"#ff4444";e.fillStyle=s,e.fillRect(c,d,o*(i.hp/i.maxHp),l),(i.isBoss||i.isDragon)&&(e.fillStyle="#fff",e.font="bold 12px Fredoka",e.textAlign="center",e.fillText(i.isDragon?"DRAGON":"BOSS",i.x,d-8))}}}function mi(i,a,t){const n=Math.sin(a*3)*.3,o=1+Math.sin(a*2)*.15;for(let g=0;g<3;g++){const I=1-g*.3,T=t*(1.3+g*.1);e.shadowBlur=(50+g*20)*o,e.shadowColor="#FF4500",e.globalAlpha=I*.3,e.fillStyle=`rgba(255, 69, 0, ${I*.2})`,e.beginPath(),e.ellipse(0,0,T*1.2,T*.7,0,0,Math.PI*2),e.fill()}e.globalAlpha=1,e.shadowBlur=0;const l=e.createLinearGradient(-t*.8,-t*.4,t*.8,t*.4);l.addColorStop(0,"#5a0000"),l.addColorStop(.2,"#8B0000"),l.addColorStop(.4,i.color),l.addColorStop(.6,"#FF6347"),l.addColorStop(.8,"#FF4500"),l.addColorStop(1,"#8B0000"),e.fillStyle=l,e.beginPath(),e.ellipse(0,0,t*1.2,t*.7,0,0,Math.PI*2),e.fill(),e.strokeStyle="#5a0000",e.lineWidth=3,e.beginPath(),e.ellipse(0,0,t*1.2,t*.7,0,0,Math.PI*2),e.stroke();for(let g=0;g<12;g++){const I=(g/12-.5)*t*1.5,T=Math.sin(g*.8)*t*.3,A=g*.3;e.fillStyle="rgba(0, 0, 0, 0.3)",e.beginPath(),e.ellipse(I+2,T+2,t*.15,t*.1,A,0,Math.PI*2),e.fill();const C=e.createRadialGradient(I,T,0,I,T,t*.15);C.addColorStop(0,"#FF6347"),C.addColorStop(.5,"#8B0000"),C.addColorStop(1,"#5a0000"),e.fillStyle=C,e.beginPath(),e.ellipse(I,T,t*.15,t*.1,A,0,Math.PI*2),e.fill(),e.fillStyle="rgba(255, 255, 255, 0.2)",e.beginPath(),e.ellipse(I-t*.05,T-t*.05,t*.08,t*.05,A,0,Math.PI*2),e.fill()}e.save(),e.translate(-t*.6,-t*.3),e.rotate(-Math.PI/4+n);const c=e.createLinearGradient(0,0,t*1.5,0);c.addColorStop(0,"rgba(139, 0, 0, 0.8)"),c.addColorStop(.5,"rgba(139, 0, 0, 0.4)"),c.addColorStop(1,"rgba(139, 0, 0, 0.1)"),e.fillStyle=c,e.beginPath(),e.moveTo(0,0),e.lineTo(t*1.5,-t*.8),e.lineTo(t*1.2,-t*.4),e.lineTo(t*.8,-t*.2),e.closePath(),e.fill(),e.strokeStyle="rgba(139, 0, 0, 0.6)",e.lineWidth=2,e.beginPath(),e.moveTo(0,0),e.lineTo(t*1.5,-t*.8),e.stroke(),e.beginPath(),e.moveTo(t*.3,-t*.15),e.lineTo(t*1.2,-t*.4),e.stroke(),e.restore(),e.save(),e.translate(t*.6,-t*.3),e.rotate(Math.PI/4-n),e.scale(-1,1),e.fillStyle=c,e.beginPath(),e.moveTo(0,0),e.lineTo(t*1.5,-t*.8),e.lineTo(t*1.2,-t*.4),e.lineTo(t*.8,-t*.2),e.closePath(),e.fill(),e.strokeStyle="rgba(139, 0, 0, 0.6)",e.lineWidth=2,e.beginPath(),e.moveTo(0,0),e.lineTo(t*1.5,-t*.8),e.stroke(),e.beginPath(),e.moveTo(t*.3,-t*.15),e.lineTo(t*1.2,-t*.4),e.stroke(),e.restore(),e.fillStyle="rgba(0, 0, 0, 0.4)",e.beginPath(),e.moveTo(-t*.7+3,-t*.6+3),e.lineTo(-t*.1+3,-t*1.1+3),e.lineTo(t*.1+3,-t*.6+3),e.lineTo(t*.2+3,-t*.4+3),e.lineTo(-t*.5+3,-t*.4+3),e.closePath(),e.fill();const d=e.createLinearGradient(-t*.7,-t*.6,-t*.1,-t*1.1);d.addColorStop(0,"#FF8C69"),d.addColorStop(.3,"#FF6347"),d.addColorStop(.6,i.color),d.addColorStop(1,"#8B0000"),e.fillStyle=d,e.beginPath(),e.moveTo(-t*.7,-t*.6),e.lineTo(-t*.1,-t*1.1),e.lineTo(t*.1,-t*.6),e.lineTo(t*.2,-t*.4),e.lineTo(-t*.5,-t*.4),e.closePath(),e.fill(),e.strokeStyle="#5a0000",e.lineWidth=3,e.beginPath(),e.moveTo(-t*.7,-t*.6),e.lineTo(-t*.1,-t*1.1),e.lineTo(t*.1,-t*.6),e.lineTo(t*.2,-t*.4),e.lineTo(-t*.5,-t*.4),e.closePath(),e.stroke(),e.fillStyle="rgba(255, 255, 255, 0.2)",e.beginPath(),e.moveTo(-t*.5,-t*.7),e.lineTo(-t*.15,-t*1),e.lineTo(t*.05,-t*.7),e.closePath(),e.fill(),e.strokeStyle="rgba(139, 0, 0, 0.6)",e.lineWidth=2,e.beginPath(),e.moveTo(-t*.2,-t*.9),e.lineTo(-t*.1,-t*1.05),e.stroke(),e.beginPath(),e.moveTo(t*.05,-t*.75),e.lineTo(-t*.1,-t*1.05),e.stroke();const s=e.createLinearGradient(-t*.55,-t*1.3,-t*.45,-t*1.4);s.addColorStop(0,"#2a0000"),s.addColorStop(.5,"#5a0000"),s.addColorStop(1,"#8B0000"),e.fillStyle=s,e.beginPath(),e.moveTo(-t*.5,-t*1.2),e.lineTo(-t*.6,-t*1.4),e.lineTo(-t*.4,-t*1.3),e.closePath(),e.fill(),e.strokeStyle="#1a0000",e.lineWidth=2,e.stroke();const f=e.createLinearGradient(-t*.25,-t*1.2,-t*.15,-t*1.3);f.addColorStop(0,"#2a0000"),f.addColorStop(.5,"#5a0000"),f.addColorStop(1,"#8B0000"),e.fillStyle=f,e.beginPath(),e.moveTo(-t*.2,-t*1.1),e.lineTo(-t*.3,-t*1.3),e.lineTo(-t*.1,-t*1.2),e.closePath(),e.fill(),e.stroke();const E=1+Math.sin(a*5)*.3;e.shadowBlur=25,e.shadowColor="#FF4500";const _=e.createRadialGradient(-t*.4,-t*.85,0,-t*.4,-t*.85,t*.2*E);_.addColorStop(0,"#fff"),_.addColorStop(.3,"#FF6347"),_.addColorStop(.7,"#FF4500"),_.addColorStop(1,"#8B0000"),e.fillStyle=_,e.beginPath(),e.arc(-t*.4,-t*.85,t*.2*E,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(-t*.15,-t*.9,t*.15*E,0,Math.PI*2),e.fill(),e.shadowBlur=0,e.fillStyle="#fff",e.beginPath(),e.arc(-t*.38,-t*.87,t*.06,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(-t*.13,-t*.92,t*.05,0,Math.PI*2),e.fill();const y=i.attackPhaseTime!==void 0?i.attackPhaseTime%.5/.5:0;if(y<.3){const g=t*1.5*(1-y),I=e.createLinearGradient(0,0,g,0);I.addColorStop(0,"rgba(255, 255, 0, 0.9)"),I.addColorStop(.3,"rgba(255, 140, 0, 0.8)"),I.addColorStop(.7,"rgba(255, 69, 0, 0.6)"),I.addColorStop(1,"rgba(255, 69, 0, 0)"),e.fillStyle=I,e.shadowBlur=20,e.shadowColor="#FF4500",e.beginPath(),e.ellipse(g/2,0,g/2,t*.3,i.angle,0,Math.PI*2),e.fill(),e.shadowBlur=0}const R=e.createLinearGradient(t*.8,t*.2,t*1.4,t*1);R.addColorStop(0,i.color),R.addColorStop(.5,"#FF6347"),R.addColorStop(1,"#8B0000"),e.strokeStyle=R,e.lineWidth=t*.15,e.lineCap="round",e.shadowBlur=10,e.shadowColor="#FF4500",e.beginPath(),e.moveTo(t*.8,t*.2),e.quadraticCurveTo(t*1.2,t*.6,t*1.4,t*1),e.stroke(),e.shadowBlur=0;for(let g=0;g<6;g++){const I=g/6,T=t*.8+I*t*.6,A=t*.2+I*t*.8,C=e.createLinearGradient(T,A,T,A+t*.15);C.addColorStop(0,"#FF6347"),C.addColorStop(.5,"#8B0000"),C.addColorStop(1,"#5a0000"),e.fillStyle=C,e.beginPath(),e.moveTo(T,A),e.lineTo(T+t*.12,A+t*.18),e.lineTo(T-t*.12,A+t*.18),e.closePath(),e.fill(),e.strokeStyle="#5a0000",e.lineWidth=1.5,e.stroke()}e.shadowBlur=12,e.shadowColor="#FF4500";for(let g=0;g<25;g++){const I=g*73.7+a,T=Math.cos(I)*t*1.3,A=Math.sin(I*1.3)*t*.9,C=.6+Math.sin(I*2)*.3,D=4+Math.sin(I*3)*3,v=e.createRadialGradient(T,A,0,T,A,D);v.addColorStop(0,`rgba(255, 255, 0, ${C})`),v.addColorStop(.5,`rgba(255, 140, 0, ${C*.8})`),v.addColorStop(1,"rgba(255, 69, 0, 0)"),e.fillStyle=v,e.beginPath(),e.arc(T,A,D,0,Math.PI*2),e.fill()}e.shadowBlur=0}function Mi(){for(const i of m)i.type==="area"&&i.id==="fire_ring"?Pi(i):i.type==="melee"&&i.id==="holy_sword"&&Ti(i)}function Ti(i){const a=i.range||r.HOLY_SWORD_RANGE,t=i.arc||r.HOLY_SWORD_ARC,n=Math.PI,o=0,l=[],c=i.lastFireTime<0?1/0:p-i.lastFireTime,d=1/i.fireRate,s=Math.min(c/(d*.4),1);if(s<1)if(k===0){const f=Ce>0?o:n;l.push({angle:f,progress:s})}else{const E=(Ce>0?0:1)===0?o:n;l.push({angle:E,progress:s})}if(i.sequentialShots&&k>0){for(const f of i.sequentialShots)if(f.swingAngle!==void 0){const E=f.time-p,_=(r.HOLY_SWORD_SEQUENTIAL_DELAY+r.HOLY_SWORD_SEQUENTIAL_DELAY_INCREASE)*.4;if(E<=_&&E>=-_){const y=Math.min(Math.max(0,1-E/_),1);l.push({angle:f.swingAngle,progress:y})}}}for(const f of l){const E=f.angle,_=f.progress;if(_<1){e.save(),e.translate(h.x,h.y),e.rotate(E);const y=t*(1-_*.5),R=-y/2,g=y/2,I=a*(.3+_*.7);e.strokeStyle="rgba(255, 215, 0, 0.3)",e.lineWidth=12,e.shadowBlur=25,e.shadowColor="#ffd700",e.lineCap="round",e.beginPath(),e.arc(0,0,I,R,g),e.stroke(),e.strokeStyle="#fff",e.lineWidth=6,e.shadowBlur=20,e.shadowColor="#ffd700",e.beginPath(),e.arc(0,0,I,R,g),e.stroke(),e.strokeStyle="#ffd700",e.lineWidth=3,e.shadowBlur=15,e.beginPath(),e.arc(0,0,I,R,g),e.stroke(),e.fillStyle="#8B4513",e.strokeStyle="#654321",e.lineWidth=2,e.shadowBlur=0,e.beginPath(),e.rect(-4,-8,8,16),e.fill(),e.stroke(),e.strokeStyle="#ffd700",e.lineWidth=3,e.beginPath(),e.moveTo(-8,-8),e.lineTo(-12,-10),e.moveTo(8,-8),e.lineTo(12,-10),e.moveTo(-8,8),e.lineTo(-12,10),e.moveTo(8,8),e.lineTo(12,10),e.stroke();const T=8;for(let v=0;v<T;v++){const Se=v/T,pe=R+(g-R)*Se,Ie=I*(.2+Se*.8),ke=Math.cos(pe)*Ie,Ye=Math.sin(pe)*Ie;e.fillStyle=`rgba(255, 255, 255, ${.6+Math.sin(p*10+v)*.4})`,e.beginPath(),e.arc(ke,Ye,4,0,Math.PI*2),e.fill()}const A=Math.cos(g)*I,C=Math.sin(g)*I,D=e.createRadialGradient(A,C,0,A,C,12);D.addColorStop(0,"rgba(255, 255, 255, 1)"),D.addColorStop(.5,"rgba(255, 215, 0, 0.8)"),D.addColorStop(1,"rgba(255, 215, 0, 0)"),e.fillStyle=D,e.beginPath(),e.arc(A,C,12,0,Math.PI*2),e.fill(),e.fillStyle="#fff",e.beginPath(),e.arc(A,C,6,0,Math.PI*2),e.fill();for(let v=0;v<5;v++){const Se=.2+v*.2,pe=R+(g-R)*Se,Ie=I*(.3+Se*.7),ke=Math.cos(pe)*Ie,Ye=Math.sin(pe)*Ie;e.fillStyle=`rgba(255, 255, 255, ${.7+Math.sin(p*8+v)*.3})`,e.beginPath(),e.arc(ke,Ye,3,0,Math.PI*2),e.fill()}e.restore()}}}function Pi(i){const a=i.radius||r.FIRE_RING_RADIUS,t=Math.floor(r.FIRE_RING_PARTICLES*(Y?.6:1)),n=p*2;e.save();for(let o=0;o<3;o++){const l=a+o*3,c=1-o*.3;e.shadowBlur=15,e.shadowColor="#ff6600";for(let d=0;d<t;d++){const s=d/t*Math.PI*2+n,f=h.x+Math.cos(s)*l,E=h.y+Math.sin(s)*l,_=e.createRadialGradient(f,E,0,f,E,8);_.addColorStop(0,`rgba(255, 255, 255, ${c})`),_.addColorStop(.3,`rgba(255, 200, 0, ${c})`),_.addColorStop(.6,`rgba(255, 100, 0, ${c})`),_.addColorStop(1,`rgba(200, 50, 0, ${c})`),e.fillStyle=_,e.beginPath(),e.arc(f,E,8,0,Math.PI*2),e.fill();const y=Math.sin(n*5+d)*.3+.7;e.globalAlpha=c*y,e.fillStyle=`rgba(255, 150, 0, ${y})`,e.beginPath(),e.arc(f,E,4,0,Math.PI*2),e.fill(),e.globalAlpha=1}}e.strokeStyle="rgba(255, 200, 0, 0.3)",e.lineWidth=2;for(let o=0;o<3;o++){const l=a-5+Math.sin(n+o)*3;e.beginPath(),e.arc(h.x,h.y,l,0,Math.PI*2),e.stroke()}e.restore()}function Ai(i){const a=p*20,t=i.x+Math.cos(i.rotation)*i.radius,n=i.y+Math.sin(i.rotation)*i.radius,o=100,l=i.x-Math.cos(i.rotation)*o,c=i.y-Math.sin(i.rotation)*o;let d=l,s=c;i.trail.length>0&&(d=i.trail[0].x,s=i.trail[0].y);const f=t,E=n,_=8,y=[];for(let g=0;g<=_;g++){const I=g/_,T=d+(f-d)*I,A=s+(E-s)*I,C=Math.sin(I*Math.PI)*8,D=Math.sin(a+I*10)*C,v=Math.cos(a+I*10)*C;y.push({x:T+D,y:A+v})}e.strokeStyle="#fff",e.lineWidth=4,e.shadowBlur=20,e.shadowColor="#00ffff",e.lineCap="round",e.lineJoin="round",e.beginPath(),e.moveTo(y[0].x,y[0].y);for(let g=1;g<y.length;g++)e.lineTo(y[g].x,y[g].y);e.stroke(),e.strokeStyle="#00ffff",e.lineWidth=2,e.shadowBlur=15,e.beginPath(),e.moveTo(y[0].x,y[0].y);for(let g=1;g<y.length;g++)e.lineTo(y[g].x,y[g].y);e.stroke();for(let g=1;g<y.length-1;g+=2){if(g%6!==1)continue;const I=10+Math.sin(a+g)*5,T=Math.atan2(y[g+1]?.y-y[g].y||0,y[g+1]?.x-y[g].x||0)+Math.PI/4,A=y[g].x+Math.cos(T)*I,C=y[g].y+Math.sin(T)*I;e.strokeStyle="#88ffff",e.lineWidth=2,e.shadowBlur=8,e.beginPath(),e.moveTo(y[g].x,y[g].y),e.lineTo(A,C),e.stroke()}e.shadowBlur=0;for(let g=0;g<y.length;g+=2){const I=y[g].x+Math.sin(a*3+g)*2,T=y[g].y+Math.cos(a*3+g)*2;e.fillStyle=`rgba(255, 255, 255, ${.8+Math.sin(a+g)*.2})`,e.beginPath(),e.arc(I,T,2,0,Math.PI*2),e.fill()}e.shadowBlur=20,e.shadowColor="#00ffff";const R=e.createRadialGradient(f,E,0,f,E,15);R.addColorStop(0,"rgba(255, 255, 255, 0.9)"),R.addColorStop(.5,"rgba(0, 255, 255, 0.6)"),R.addColorStop(1,"rgba(0, 255, 255, 0)"),e.fillStyle=R,e.beginPath(),e.arc(f,E,15,0,Math.PI*2),e.fill(),e.shadowBlur=0}function Li(i){e.save(),e.translate(i.x,i.y),e.rotate(i.rotation),e.shadowBlur=20,e.shadowColor="#FFD700";const a=e.createRadialGradient(0,0,i.radius*.6,0,0,i.radius);a.addColorStop(0,"rgba(255, 215, 0, 0.6)"),a.addColorStop(.5,"rgba(255, 140, 0, 0.4)"),a.addColorStop(1,"rgba(255, 140, 0, 0.2)"),e.strokeStyle=a,e.lineWidth=i.radius*.4,e.beginPath(),e.arc(0,0,i.radius*.8,0,Math.PI*2),e.stroke(),e.strokeStyle="#FFD700",e.lineWidth=4,e.shadowBlur=15,e.beginPath(),e.arc(0,0,i.radius*.8,0,Math.PI*2),e.stroke();for(let t=0;t<8;t++){const n=t/8*Math.PI*2,o=Math.cos(n)*i.radius*.8,l=Math.sin(n)*i.radius*.8;e.fillStyle=`rgba(255, 255, 255, ${.8+Math.sin(p*5+t)*.2})`,e.beginPath(),e.arc(o,l,3,0,Math.PI*2),e.fill()}e.restore()}function Ri(i){if(e.save(),i.target){const a=Math.max(0,i.y-200),t=i.target.y;e.shadowBlur=30,e.shadowColor="#00FFFF",e.strokeStyle="rgba(0, 255, 255, 0.6)",e.lineWidth=20,e.beginPath(),e.moveTo(i.x,a),e.lineTo(i.x,t),e.stroke(),e.strokeStyle="#00FFFF",e.lineWidth=8,e.shadowBlur=15,e.beginPath(),e.moveTo(i.x,a),e.lineTo(i.x,t),e.stroke(),e.fillStyle="#FFFFFF",e.shadowBlur=20,e.beginPath(),e.arc(i.x,t,i.radius,0,Math.PI*2),e.fill()}e.restore()}function Ci(i){e.save(),e.translate(i.x,i.y),e.rotate(i.rotation),e.shadowBlur=15,e.shadowColor="#9370DB";const a=e.createLinearGradient(-i.radius,0,i.radius,0);a.addColorStop(0,"#9370DB"),a.addColorStop(.5,"#BA55D3"),a.addColorStop(1,"#DA70D6"),e.fillStyle=a,e.beginPath(),e.moveTo(i.radius,0),e.lineTo(-i.radius*.5,-i.radius*.5),e.lineTo(-i.radius*.3,0),e.lineTo(-i.radius*.5,i.radius*.5),e.closePath(),e.fill(),e.fillStyle="#FFFFFF",e.shadowBlur=0,e.beginPath(),e.arc(0,0,i.radius*.3,0,Math.PI*2),e.fill(),e.restore()}function xi(){if(L.length!==0)for(const i of L){if(e.save(),i.isEnemyProjectile){if(e.translate(i.x,i.y),e.rotate(i.rotation),i.weaponId==="dragon_fire"||i.weaponId==="dragon_exploding_fireball"){const a=i.weaponId==="dragon_exploding_fireball",t=a?i.radius:7,n=a?i.radius*1.8:i.radius*1.5;e.shadowBlur=20,e.shadowColor="#FF4500";const o=e.createRadialGradient(0,0,0,0,0,n);o.addColorStop(0,"rgba(255, 255, 0, 0.6)"),o.addColorStop(.3,"rgba(255, 140, 0, 0.5)"),o.addColorStop(.7,"rgba(255, 69, 0, 0.3)"),o.addColorStop(1,"rgba(255, 69, 0, 0)"),e.fillStyle=o,e.beginPath(),e.arc(0,0,n,0,Math.PI*2),e.fill();const l=e.createRadialGradient(0,0,0,0,0,t);l.addColorStop(0,"#fff"),l.addColorStop(.2,"#FFD700"),l.addColorStop(.5,"#FF6347"),l.addColorStop(.8,"#FF4500"),l.addColorStop(1,"#8B0000"),e.fillStyle=l,e.beginPath(),e.arc(0,0,t,0,Math.PI*2),e.fill(),e.shadowBlur=0,e.fillStyle="#FFD700",e.beginPath(),e.arc(0,0,t*.4,0,Math.PI*2),e.fill(),e.shadowBlur=5,e.shadowColor="#FF4500";for(let c=0;c<6;c++){const d=c/6*Math.PI*2+p*3,s=Math.cos(d)*i.radius*.8,f=Math.sin(d)*i.radius*.8,E=.6+Math.sin(p*5+c)*.3;e.fillStyle=`rgba(255, 69, 0, ${E})`,e.beginPath(),e.arc(s,f,3,0,Math.PI*2),e.fill()}e.shadowBlur=0}else{e.shadowBlur=10,e.shadowColor="#9370DB";const a=e.createRadialGradient(0,0,0,0,0,i.radius);a.addColorStop(0,"#ff6b9d"),a.addColorStop(.5,"#9370DB"),a.addColorStop(1,"#6a1b9a"),e.fillStyle=a,e.beginPath(),e.arc(0,0,i.radius,0,Math.PI*2),e.fill(),e.fillStyle="#fff",e.beginPath(),e.arc(0,0,i.radius*.5,0,Math.PI*2),e.fill()}e.restore();continue}for(let a=0;a<i.trail.length;a++){const t=i.trail[a];e.globalAlpha=t.alpha*.5,e.fillStyle="#8a2be2",e.beginPath(),e.arc(t.x,t.y,i.radius*t.alpha,0,Math.PI*2),e.fill()}if(e.globalAlpha=1,i.weaponId==="lightning_bolt")e.restore(),Ai(i),e.save(),e.restore();else if(i.weaponId==="light_ring")e.restore(),Li(i),e.save(),e.restore();else if(i.weaponId==="laser_strike")e.restore(),Ri(i),e.save(),e.restore();else if(i.weaponId==="arcane_dart")e.restore(),Ci(i),e.save(),e.restore();else{if(e.translate(i.x,i.y),e.rotate(i.rotation),i.weaponId==="magic_missile"){const a=p*10;e.shadowBlur=20,e.shadowColor="#8a2be2";const t=e.createRadialGradient(0,0,0,0,0,i.radius);t.addColorStop(0,"#fff"),t.addColorStop(.3,"#a855f7"),t.addColorStop(.6,"#8a2be2"),t.addColorStop(1,"#5a1a9a"),e.fillStyle=t,e.beginPath(),e.arc(0,0,i.radius,0,Math.PI*2),e.fill(),e.strokeStyle="#fff",e.lineWidth=2,e.beginPath(),e.arc(0,0,i.radius,0,Math.PI*2),e.stroke(),e.shadowBlur=0;for(let n=0;n<4;n++){const o=a+n*Math.PI/2,l=i.radius*1.5,c=Math.cos(o)*l,d=Math.sin(o)*l;e.fillStyle=`rgba(255, 255, 255, ${.9+Math.sin(a+n)*.1})`,e.beginPath(),e.arc(c,d,3,0,Math.PI*2),e.fill()}e.fillStyle="#fff",e.beginPath(),e.arc(0,0,i.radius*.5,0,Math.PI*2),e.fill()}else e.fillStyle="#8a2be2",e.strokeStyle="#fff",e.lineWidth=2,e.beginPath(),e.arc(0,0,i.radius,0,Math.PI*2),e.fill(),e.stroke();e.restore()}}}function vi(){for(const i of ee){e.save(),e.translate(i.x,i.y),e.rotate(i.rotation);const t=Math.sin(i.pulseTime)*.2+1;e.shadowBlur=30,e.shadowColor="#FFD700";const n=i.radius*1.5*t,o=i.radius*t,l=e.createLinearGradient(-n/2,-o/2,n/2,o/2);l.addColorStop(0,"#FFD700"),l.addColorStop(.5,"#FFA500"),l.addColorStop(1,"#FF8C00"),e.fillStyle=l,e.fillRect(-n/2,-o/2,n,o),e.fillStyle="#FF8C00",e.fillRect(-n/2,-o/2,n,o*.3),e.fillStyle="#B8860B",e.beginPath(),e.arc(0,o*.1,i.radius*.2,0,Math.PI*2),e.fill(),e.strokeStyle="#B8860B",e.lineWidth=2,e.beginPath(),e.moveTo(-n/2,o*.2),e.lineTo(n/2,o*.2),e.stroke(),e.beginPath(),e.moveTo(-n/2,-o*.1),e.lineTo(n/2,-o*.1),e.stroke(),e.fillStyle="rgba(255, 255, 255, 0.3)",e.fillRect(-n/2,-o/2,n,o*.2),e.shadowBlur=0,e.restore()}}function bi(){for(const i of z){e.save(),e.translate(i.x,i.y),e.rotate(i.rotation),e.fillStyle="#FFD700",e.strokeStyle="#FFA500",e.lineWidth=2,e.beginPath();for(let a=0;a<5;a++){const t=a*Math.PI*2/5-Math.PI/2,n=Math.cos(t)*i.radius,o=Math.sin(t)*i.radius;a===0?e.moveTo(n,o):e.lineTo(n,o)}e.closePath(),e.fill(),e.stroke(),e.shadowBlur=8,e.shadowColor="#FFD700",e.fill(),e.restore()}}function wi(){for(const i of b){const a=i.life/i.maxLife;e.save(),e.globalAlpha=a,e.fillStyle=i.color,e.beginPath(),e.arc(i.x,i.y,i.size,0,Math.PI*2),e.fill(),e.restore()}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",et):et();
</head>
<body>
    <canvas id="gameCanvas"></canvas>

    <!-- HUD -->
    <div id="hud" class="hidden">
        <div class="hud-top">
            <div class="health-bar-container">
                <div class="health-bar-label">HP</div>
                <div class="health-bar">
                    <div class="health-bar-fill" id="healthBarFill"></div>
                </div>
            </div>
        </div>
        <div class="hud-top-right">
            <div class="level-display" id="levelDisplay">Lv 1</div>
            <div class="timer-display" id="timerDisplay">0:00</div>
            <div class="score-display" id="scoreDisplay">0</div>
        </div>
        <div class="weapons-display" id="weaponsDisplay"></div>
        <div class="xp-bar-container">
            <div class="xp-bar-label">XP</div>
            <div class="xp-bar">
                <div class="xp-bar-fill" id="xpBarFill"></div>
            </div>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="startScreen" class="overlay">
        <div class="content">
            <h1 class="game-title">Arcane Fighter</h1>
            <p class="subtitle">Survive the waves</p>
            <button class="btn start-btn" id="startButton">Start</button>
        </div>
    </div>

    <!-- Weapon Selection Screen -->
    <div id="weaponSelectScreen" class="overlay hidden">
        <div class="content">
            <h1 class="game-title">Choose Your Weapon</h1>
            <p class="subtitle">Select your starting weapon</p>
            <div class="weapon-grid">
                <!-- Weapon cards are dynamically generated -->
            </div>
        </div>
    </div>

    <!-- Settings Button -->
    <button class="settings-btn hidden" id="settingsBtn">
        <svg viewBox="0 0 24 24">
            <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5a3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97c0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.4-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1c0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/>
        </svg>
    </button>

    <!-- Settings Modal -->
    <div id="settingsModal" class="settings-modal hidden">
        <h2 class="settings-title">Settings</h2>
        <div class="settings-row">
            <div class="settings-label">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                </svg>
                <span>Music</span>
            </div>
            <div class="toggle" id="musicToggle"></div>
        </div>
        <div class="settings-row">
            <div class="settings-label">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                </svg>
                <span>FX</span>
            </div>
            <div class="toggle" id="fxToggle"></div>
        </div>
        <div class="settings-row">
            <div class="settings-label">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M0 15h2V9H0v6zm3 2h2V7H3v10zm19-8v6h2V9h-2zm-3 8h2V7h-2v10zm-5-12h2V3h-2v2zm0 16h2v-2h-2v2zM12 5h2V3h-2v2zm0 16h2v-2h-2v2zm-4-4H6v-2h2v2zm0-4H6V7h2v2zm8 0h-2v-2h2v2zm0-4h-2V7h2v2z"/>
                </svg>
                <span>Haptics</span>
            </div>
            <div class="toggle" id="hapticsToggle"></div>
        </div>
        <button class="btn settings-close" id="settingsClose">Close</button>
    </div>

    <!-- Upgrade Screen -->
    <div id="upgradeScreen" class="overlay hidden">
        <div class="content">
            <h2 class="upgrade-title">LEVEL UP!</h2>
            <p class="upgrade-subtitle">Choose your next upgrade</p>
            <div class="upgrade-cards-container" id="upgradeCardsContainer"></div>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="overlay hidden">
        <div class="content">
            <h2 class="game-over-title">Game Over</h2>
            <div class="final-score-container">
                <div class="final-score-label">Final Score</div>
                <div class="final-score" id="finalScore">0</div>
            </div>
            <div class="game-over-buttons">
                <button class="btn" id="restartButton">Play Again</button>
                <button class="btn btn-secondary" id="menuButton">Menu</button>
            </div>
        </div>
    </div>

    <div id="victoryScreen" class="overlay hidden">
        <div class="content">
            <h2 class="game-over-title" style="color: #FFD700; text-shadow: 0 4px 20px rgba(255, 215, 0, 0.8);">Victory!</h2>
            <div style="font-size: 1.5rem; color: rgba(255, 255, 255, 0.9); margin: 20px 0;">
                You defeated the Dragon!
            </div>
            <div class="final-score-container">
                <div class="final-score-label">Final Score</div>
                <div class="final-score" id="victoryScore">0</div>
            </div>
            <div class="game-over-buttons">
                <button class="btn" id="victoryRestartButton">Play Again</button>
                <button class="btn btn-secondary" id="victoryMenuButton">Menu</button>
            </div>
        </div>
    </div>

</body>
</html>
